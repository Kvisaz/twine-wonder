var SOURCE = '<!DOCTYPE html>\n' +
    '    <html>\n' +
    '        <head>\n' +
    '            <meta name="viewport" content="width=device-width, initial-scale=1">\n' +
    '            <meta charset="utf-8">\n' +
    '            <title>{{STORY_NAME}}</title>\n' +
    '            <style></style>\n' +
    '        </head>\n' +
    '        <body>\n' +
    '            <tw-story tags></tw-story>\n' +
    '            {{STORY_DATA}}\n' +
    '            <script>' + "/*! For license information please see index.js.LICENSE.txt */\n!function(e){var n={};function r(t){if(n[t])return n[t].exports;var a=n[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=n,r.d=function(e,n,t){r.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},r.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},r.t=function(e,n){if(1&n&&(e=r(e)),8&n)return e;if(4&n&&\"object\"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(r.r(t),Object.defineProperty(t,\"default\",{enumerable:!0,value:e}),2&n&&\"string\"!=typeof e)for(var a in e)r.d(t,a,function(n){return e[n]}.bind(null,a));return t},r.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(n,\"a\",n),n},r.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},r.p=\"\",r(r.s=\"./wonder-format/start.ts\")}({\"./wonder-format/start.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar TwineParser_1 = __webpack_require__(/*! ./ts/parser/TwineParser */ \"./wonder-format/ts/parser/TwineParser.ts\");\\r\\nvar GameLogic_1 = __webpack_require__(/*! ./ts/twine-game/GameLogic */ \"./wonder-format/ts/twine-game/GameLogic.ts\");\\r\\nvar GameView_1 = __webpack_require__(/*! ./ts/twine-game/GameView */ \"./wonder-format/ts/twine-game/GameView.ts\");\\r\\nvar Constants_1 = __webpack_require__(/*! ./ts/Constants */ \"./wonder-format/ts/Constants.ts\");\\r\\n// @ts-ignore from webpack\\r\\nvar VERSION = \"game version 0.6.16\";\\r\\nconsole.log(\"..............................\");\\r\\nconsole.log(\"Twine Wonder parser \" + VERSION);\\r\\nconsole.log(\"..............................\");\\r\\nvar story = TwineParser_1.parseTwineData();\\r\\nconsole.log(\"story parsed = \", story);\\r\\nvar logic = new GameLogic_1.GameLogic();\\r\\nvar view = new GameView_1.GameView();\\r\\nview.injectStyle(Constants_1.DEFAULT_STYLE);\\r\\nview.injectStyle(story.style);\\r\\nlogic.loadStory(story);\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/start.ts?')},\"./wonder-format/ts/Constants.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\n// twine tags\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nexports.STORY_SELECTOR = \"tw-storydata\";\\r\\nexports.PASSAGE_SELECTOR = \"tw-passagedata\";\\r\\nexports.COMMON_CSS = {\\r\\n    displayNone: \"displayNone\",\\r\\n    pointerOver: \"pointerOver\",\\r\\n    visited: \"visited\",\\r\\n    back: \"back\"\\r\\n};\\r\\n// wonder selector\\r\\nexports.WONDER = {\\r\\n    contentId: \"wonder-content\",\\r\\n    pageClass: \"page\",\\r\\n    pageContentClass: \"page-content\",\\r\\n    textClass: \"text\",\\r\\n    choiceClass: \"choice\",\\r\\n    linkClass: \"link\",\\r\\n    linkAloneClass: \"link-alone\",\\r\\n    newLineClass: \"newLine\",\\r\\n    linkInlineClass: \"inline\",\\r\\n    noSelectClass: \"noselect\",\\r\\n    selectClass: \"select\",\\r\\n    paramClass: \\'params\\',\\r\\n    visitedClass: exports.COMMON_CSS.visited,\\r\\n    backClass: exports.COMMON_CSS.back,\\r\\n    invisibleClass: exports.COMMON_CSS.displayNone,\\r\\n    template: {\\r\\n        text: \"<text/>\",\\r\\n        choices: \"<choices/>\",\\r\\n        choiceStart: \"<choice>\",\\r\\n        choiceEnd: \"</choice>\",\\r\\n        choiceText: \"<choice-text/>\",\\r\\n        choiceId: \"<choice-id/>\",\\r\\n    },\\r\\n    passages: {\\r\\n        config: \"wonder.config\",\\r\\n        // todo\\r\\n        pageFormat: \"wonder.format.page\",\\r\\n        choiceFormat: \"wonder.format.choice\",\\r\\n        textFormat: \"wonder.format.text\",\\r\\n    },\\r\\n    markLang: {\\r\\n        varStart: \"var\",\\r\\n        commandSplitter: \":\",\\r\\n    },\\r\\n    inlineStart: \"=\",\\r\\n};\\r\\nvar REGEXP_ANY = \\'([\\\\\\\\s\\\\\\\\S]*?)\\';\\r\\n// regexps\\r\\nexports.REGEXP = {\\r\\n    exeScript: new RegExp(\\'{{\\' + REGEXP_ANY + \\'}}\\', \"g\"),\\r\\n    // /\\\\[\\\\[(.*?)\\\\]\\\\]/g - при переводе в строку удваивем  \\\\\\r\\n    twineLink: new RegExp(\\'\\\\\\\\[\\\\\\\\[\\' + REGEXP_ANY + \\'\\\\\\\\]\\\\\\\\]\\', \"g\"),\\r\\n};\\r\\n// templates\\r\\nexports.PAGE_TEMPLATE = \"<div class=\\\\\"\" + exports.WONDER.noSelectClass + \" \" + exports.WONDER.pageClass + \"\\\\\"></div>\";\\r\\nexports.LINK_TEMPLATE = \"<span class=\\\\\"\" + exports.WONDER.linkClass + \"  \" + exports.WONDER.linkAloneClass + \"\\\\\" data-id=\\\\\"\" + exports.WONDER.template.choiceId + \"\\\\\">\" + exports.WONDER.template.choiceText + \"</span>\";\\r\\nexports.LINK_INLINE_TEMPLATE = \"<span class=\\\\\"\" + exports.WONDER.linkClass + \"\\\\\" data-id=\\\\\"\" + exports.WONDER.template.choiceId + \"\\\\\">\" + exports.WONDER.template.choiceText + \"</span>\";\\r\\nexports.BACK_TEMPLATE = \"<div class=\\\\\"\" + exports.WONDER.backClass + \"\\\\\">\\\\u041D\\\\u0430\\\\u0437\\\\u0430\\\\u0434</div>\";\\r\\n// done 0 скрипты через {{}}\\r\\n// todo 1 произвольное создание параметров, инжектирование в params\\r\\n// rejected 2 общий шаблон Passage-Template - конфликт display: none с flex\\r\\n// done 3 flex css для page\\r\\nexports.PASSAGE_TEMPLATE = \"<div class=\\\\\"\" + exports.WONDER.pageContentClass + \"\\\\\">\\\\n\" + exports.BACK_TEMPLATE + \"\\\\n<div class=\\\\\"\" + exports.WONDER.paramClass + \"\\\\\" ><div id=\\\\\"gold\\\\\"></div></div>\\\\n<div class=\\\\\"\" + exports.WONDER.textClass + \"\\\\\"><text/></div>\\\\n</div>\";\\r\\n//language=CSS\\r\\nexports.DEFAULT_STYLE = \"\\\\n     * {user-select: none;}\\\\n    .noselect { user-select: none; }    \\\\n    .select {  user-select: text; }\\\\n    .page .displayNone, .displayNone {\\\\n        display: none; \\\\n    }\\\\n    html, body{height: 100%}\\\\n    .pointerOver {\\\\n        cursor: pointer;\\\\n    }\\\\n    \\\\n    ul, li {\\\\n        margin: 0;\\\\n        padding: 0;\\\\n        list-style: none;\\\\n    }\\\\n    \\\\n    body {\\\\n        margin: 0;\\\\n        padding: 0;\\\\n        background: #ceceb7;\\\\n        font-family: \\\\\"Verdana\\\\\", \\\\\"Roboto\\\\\", \\\\\"Open Sans\\\\\", sans-serif;\\\\n        position: relative;\\\\n        display: flex;\\\\n        justify-content: center;\\\\n        align-items: start;\\\\n    }\\\\n    \\\\n    .\" + exports.WONDER.newLineClass + \" {\\\\n        display: block;\\\\n    }\\\\n    \\\\n    #\" + exports.WONDER.contentId + \" {\\\\n        width: 800px;\\\\n        border-radius: 0 0 8px 8px;\\\\n        overflow: hidden;\\\\n    }\\\\n    \\\\n    .\" + exports.WONDER.pageClass + \" {\\\\n          background: beige;          \\\\n     }\\\\n     \\\\n     .\" + exports.WONDER.pageContentClass + \" {\\\\n          display: flex;\\\\n          flex-direction: column;\\\\n          padding: 12px;\\\\n     }\\\\n        \\\\n    .\" + exports.WONDER.paramClass + \"{\\\\n        margin-bottom: 12px;\\\\n    }\\\\n        \\\\n        \\\\n    .\" + exports.WONDER.textClass + \" {\\\\n        margin: 0;\\\\n        font-size: 18px;\\\\n        line-height: 26px;\\\\n    }\\\\n    \\\\n    .\" + exports.WONDER.linkClass + \"{\\\\n        display: block;\\\\n        cursor: pointer;\\\\n        padding: 5px 35px;\\\\n        border-radius: 5px;\\\\n        background: #d5c695;\\\\n    }\\\\n        \\\\n    .\" + exports.WONDER.linkClass + \":hover, .\" + exports.WONDER.backClass + \":hover{\\\\n        color: #4b0d1e;\\\\n        background: #d5b562;       \\\\n    }\\\\n    \\\\n    .\" + exports.WONDER.visitedClass + \":after {\\\\n        content: \\'  (\\\\u043F\\\\u0440\\\\u043E\\\\u0447\\\\u0438\\\\u0442\\\\u0430\\\\u043D\\\\u043E)\\';\\\\n        font-size: smaller;\\\\n     }\\\\n     \\\\n     .\" + exports.WONDER.visitedClass + \" {\\\\n        opacity: 0.65;\\\\n        font-size: smaller;\\\\n     }\\\\n    \\\\n    .\" + exports.WONDER.backClass + \" {\\\\n        cursor: pointer;\\\\n        display: inline-block;\\\\n        margin-left: 0;\\\\n        margin-right: auto;\\\\n        margin-bottom: 4px;\\\\n        padding: 4px;\\\\n        border-radius: 5px;\\\\n        background: #eae2c5;\\\\n        color: #6c6c6c;\\\\n    }\\\\n    \\\\n     .\" + exports.WONDER.backClass + \":before {\\\\n        content: \\'<\\';\\\\n     }\\\\n   \\\\n    \\\\n    .\" + exports.WONDER.linkAloneClass + \"{\\\\n        margin-top: 0px;\\\\n    }\\\\n    \\\\n    .\" + exports.WONDER.linkAloneClass + \":hover{\\\\n        margin-top: -2px;\\\\n        margin-bottom: 2px;\\\\n        box-shadow: 2px 2px 1px #414141;\\\\n    }\\\\n    \\\\n    #\" + \"c-wrapper\" /* wrapperId */ + \"{\\\\n        position: absolute;\\\\n        display: flex;\\\\n        flex-direction: column;\\\\n        top: 0;\\\\n        left: 0;\\\\n    }\\\\n    \\\\n    .\" + \"c-button\" /* button */ + \"{\\\\n        width: 96px;     \\\\n        line-height: 1em;\\\\n        background: antiquewhite;\\\\n        margin-top: 24px;\\\\n        text-align: center;\\\\n        cursor: pointer;\\\\n        box-shadow: 1px 2px 6px black;\\\\n    }\\\\n    \\\\n    .\" + \"c-button\" /* button */ + \":hover {\\\\n        transform: scale(1.09) translateX(4px);\\\\n        box-shadow: 1px 2px 6px black;\\\\n    }\\\\n    \\\\n    .\" + \"c-bt-title\" /* buttonTitle */ + \"{\\\\n        font-size: 16px;\\\\n        text-align: center;\\\\n        height: 1em;\\\\n        line-height: 1em;\\\\n        background: #b66e13;\\\\n        margin-bottom: 12px;\\\\n        padding: 2px;\\\\n    }\\\\n    \\\\n    .\" + \"c-bt-content\" /* buttonContent */ + \"{\\\\n        font-size: 24px;\\\\n        text-align: center;\\\\n        height: 1em;\\\\n        line-height: 1em;\\\\n        margin-bottom: 12px;\\\\n    }\\\\n    \\\\n    .\" + \"c-list\" /* list */ + \"{\\\\n        position: absolute;\\\\n        height: 89%;\\\\n        width: 800px;        \\\\n        top: 10%;\\\\n        left: 0;\\\\n        transform: translate(-100%, 0);\\\\n        background: #876b38;\\\\n        transition-duration: 0.45s;\\\\n        animation-timing-function: ease-out;\\\\n        box-shadow: 1px 2px 6px rgba(0,0,0,0.65);\\\\n    }\\\\n    \\\\n    .\" + \"c-list-show\" /* listShow */ + \"{\\\\n        left: 50%;\\\\n        transform: translate(-49%, 0);\\\\n    }\\\\n    \\\\n    .\" + \"c-list-title\" /* listTitle */ + \"{\\\\n        font-size: 32px;    \\\\n         color: antiquewhite;   \\\\n        margin: 12px;\\\\n     }\\\\n        \\\\n    .\" + \"c-list-content\" /* listContent */ + \"{\\\\n        font-size: 24px;\\\\n        overflow: auto;\\\\n        padding: 12px;\\\\n        background: #d7d7c5;\\\\n        border: 1px solid #afafaf;\\\\n        height: 90%;\\\\n    }\\\\n    .\" + \"c-item\" /* listItem */ + \"{ \\\\n         padding: 12px;\\\\n         border: 1px solid #afafaf;\\\\n         cursor: pointer;\\\\n         background: beige;\\\\n         border-radius: 4px;\\\\n         margin-top: 6px;\\\\n    }\\\\n    \\\\n    .\" + \"c-item\" /* listItem */ + \":hover {\\\\n        transform: scale(1.01);\\\\n        background: #fffffc;\\\\n        box-shadow: 1px 2px 6px rgba(0,0,0,0.65);\\\\n    }   \\\\n    \\\\n    .\" + \"c-list-content\" /* listContent */ + \"::-webkit-scrollbar { width: 32px; }\\\\n        \\\\n    .\" + \"c-list-content\" /* listContent */ + \"::-webkit-scrollbar-track {\\\\n        background: #d0ac75;\\\\n        border-radius: 16px;    \\\\n    }\\\\n    .\" + \"c-list-content\" /* listContent */ + \"::-webkit-scrollbar-thumb {\\\\n          background-color: #f1760c;   \\\\n          border-radius: 20px;       \\\\n          border: 2px solid #6f3909; \\\\n    }\\\\n    \\\\n    .\" + \"c-page\" /* page */ + \"{\\\\n        position: absolute;\\\\n        height: 95%;\\\\n        width: 800px;        \\\\n        top: 3%;\\\\n        left: 0;\\\\n        transform: translate(-100%, 0);        \\\\n        background: beige;\\\\n        overflow: auto;\\\\n        transition-duration: 0.45s;\\\\n        animation-timing-function: ease-out;\\\\n        box-shadow: 1px 2px 6px rgba(0,0,0,0.65);\\\\n    }\\\\n    \\\\n    .\" + \"c-page-content\" /* pageContent */ + \"{\\\\n        margin: 12px 12px 16px;\\\\n    }\\\\n    \\\\n    .\" + \"c-page-show\" /* pageShow */ + \"{\\\\n        left: 50%;\\\\n        transform: translate(-47%, 0);\\\\n    }\\\\n    \\\\n    .\" + \"c-page\" /* page */ + \"::-webkit-scrollbar { width: 32px; }\\\\n        \\\\n    .\" + \"c-page\" /* page */ + \"::-webkit-scrollbar-track {\\\\n        background: #d0ac75;\\\\n        border-radius: 16px;    \\\\n    }\\\\n    .\" + \"c-page\" /* page */ + \"::-webkit-scrollbar-thumb {\\\\n          background-color: #ce9643;   \\\\n          border-radius: 20px;       \\\\n          border: 2px solid #efd0a6; \\\\n    }\\\\n    \\\\n    @media screen and (max-width: 800px){\\\\n        .\" + exports.WONDER.contentId + \" {\\\\n             width: 100%;\\\\n             margin: 0;\\\\n             border-radius: 0;\\\\n        }\\\\n    }\\\\n\";\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/Constants.ts?')},\"./wonder-format/ts/app-core/ArrayUtils.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar ArrayUtils = /** @class */ (function () {\\r\\n    function ArrayUtils() {\\r\\n    }\\r\\n    /**\\r\\n     * getRandom - взять n рандомных элементов из массива\\r\\n     * исходный массив не меняется\\r\\n     * @param arr\\r\\n     * @param n\\r\\n     */\\r\\n    ArrayUtils.getRandom = function (arr, n) {\\r\\n        if (n === void 0) { n = 1; }\\r\\n        var result = new Array(n), len = arr.length, taken = new Array(len);\\r\\n        if (n > len)\\r\\n            throw new RangeError(\"getRandom: more elements taken than available\");\\r\\n        while (n--) {\\r\\n            var x = Math.floor(Math.random() * len);\\r\\n            result[n] = arr[x in taken ? taken[x] : x];\\r\\n            taken[x] = --len in taken ? taken[len] : len;\\r\\n        }\\r\\n        return result;\\r\\n    };\\r\\n    /**\\r\\n     * pushUnique - поместить элемент в массив, только если его там нет\\r\\n     */\\r\\n    ArrayUtils.pushUnique = function (arr, el) {\\r\\n        if (arr.indexOf(el) < 0)\\r\\n            arr.push(el);\\r\\n        return arr;\\r\\n    };\\r\\n    ArrayUtils.removeChild = function (arr, el) {\\r\\n        var index = arr.indexOf(el);\\r\\n        if (index > -1) {\\r\\n            arr.splice(index, 1);\\r\\n        }\\r\\n    };\\r\\n    ArrayUtils.remove = function (arr, index) {\\r\\n        if (index > -1) {\\r\\n            return arr.splice(index, 1)[0];\\r\\n        }\\r\\n        else\\r\\n            return null;\\r\\n    };\\r\\n    ArrayUtils.removeLast = function (arr, amount) {\\r\\n        while (amount-- > 0)\\r\\n            arr.pop();\\r\\n    };\\r\\n    /**\\r\\n     * Перемешать массив, результат повторяется при каждом seed\\r\\n     * @param arr\\r\\n     * @param seed -\\r\\n     */\\r\\n    ArrayUtils.shuffleWithSeed = function (arr, seed) {\\r\\n        if (seed === void 0) { seed = 17; }\\r\\n        var i, next, tmp;\\r\\n        var length = arr.length;\\r\\n        var seed2 = 31; // оба сида должны быть простыми числами\\r\\n        var randomI;\\r\\n        for (i = 0; i < length; i++) {\\r\\n            randomI = (seed * i + seed2) % length;\\r\\n            tmp = arr[randomI];\\r\\n            arr[randomI] = arr[i];\\r\\n            arr[i] = tmp;\\r\\n        }\\r\\n        return arr;\\r\\n    };\\r\\n    /**\\r\\n     *  перемешать массив, мутабельно\\r\\n     */\\r\\n    ArrayUtils.shuffle = function (arr, order) {\\r\\n        if (order === void 0) { order = ArrayShuffleOrder.random; }\\r\\n        switch (order) {\\r\\n            case ArrayShuffleOrder.same:\\r\\n                return arr;\\r\\n            case ArrayShuffleOrder.chaos:\\r\\n                return arr.sort(function (a, b) { return Math.random() - 0.5; });\\r\\n            case ArrayShuffleOrder.random:\\r\\n                return ArrayUtils.shuffleWithSeed(arr, 13);\\r\\n        }\\r\\n    };\\r\\n    /**\\r\\n     *  применить массив args к arr с помощью applyFn\\r\\n     * @param arr\\r\\n     * @param args\\r\\n     * @param applyFn\\r\\n     * @param useLast - если true, то последний из args используется для всех оставшихся элементов массива,\\r\\n     *          если аргументов меньше по длине, чем arr - последний args используется до конца\\r\\n     *          если false - обработка заканчивается с последним указанным из args\\r\\n     */\\r\\n    ArrayUtils.updateArray = function (arr, args, applyFn, useLast) {\\r\\n        if (useLast === void 0) { useLast = true; }\\r\\n        if (arr == null || args == null || args.length == 0)\\r\\n            return;\\r\\n        var next;\\r\\n        var last;\\r\\n        arr.forEach(function (el, i) {\\r\\n            next = i < args.length ? args[i] : last;\\r\\n            applyFn(el, next);\\r\\n            last = next;\\r\\n        });\\r\\n    };\\r\\n    return ArrayUtils;\\r\\n}());\\r\\nexports.ArrayUtils = ArrayUtils;\\r\\n// порядок карт в колоде\\r\\nvar ArrayShuffleOrder;\\r\\n(function (ArrayShuffleOrder) {\\r\\n    ArrayShuffleOrder[\"random\"] = \"random\";\\r\\n    ArrayShuffleOrder[\"same\"] = \"same\";\\r\\n    ArrayShuffleOrder[\"chaos\"] = \"chaos\";\\r\\n})(ArrayShuffleOrder = exports.ArrayShuffleOrder || (exports.ArrayShuffleOrder = {}));\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/app-core/ArrayUtils.ts?')},\"./wonder-format/ts/app-core/DomUtils.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar DomUtils = /** @class */ (function () {\\r\\n    function DomUtils() {\\r\\n    }\\r\\n    DomUtils.divWith = function (content) {\\r\\n        var div = document.createElement(\"div\");\\r\\n        div.innerHTML = content;\\r\\n        return div;\\r\\n    };\\r\\n    DomUtils.elementFromTemplate = function (template) {\\r\\n        var div = DomUtils.divWith(template);\\r\\n        return div.firstChild;\\r\\n    };\\r\\n    // добавить child в parent под child с заданным id (если такой существует)\\r\\n    DomUtils.addChildBefore = function (parent, newChild, id) {\\r\\n        var child;\\r\\n        var notAdded = true;\\r\\n        var children = parent.children;\\r\\n        // если id не задан - добавляем последним\\r\\n        if (id == null || id.length == 0) {\\r\\n            parent.appendChild(newChild);\\r\\n            return;\\r\\n        }\\r\\n        // иначе пробуем найти и вставить перед элементом с id\\r\\n        for (var i = 0; i < children.length; i++) {\\r\\n            child = children[i];\\r\\n            if (child.id == id) {\\r\\n                parent.insertBefore(newChild, child);\\r\\n                notAdded = false;\\r\\n                return;\\r\\n            }\\r\\n        }\\r\\n        // если не нашли - добавляем последнием\\r\\n        if (notAdded) {\\r\\n            parent.appendChild(newChild);\\r\\n        }\\r\\n    };\\r\\n    DomUtils.remove = function (el) {\\r\\n        if (el.parentNode)\\r\\n            el.parentNode.removeChild(el);\\r\\n    };\\r\\n    // добавить, только если ребенка нет\\r\\n    DomUtils.addChildIfNot = function (parent, el) {\\r\\n        if (el.parentNode != parent)\\r\\n            parent.appendChild(el);\\r\\n    };\\r\\n    DomUtils.bringToTop = function (el) {\\r\\n        if (el.parentNode)\\r\\n            el.parentNode.appendChild(el);\\r\\n    };\\r\\n    DomUtils.matches = function (el, selector) {\\r\\n        return matches.call(el, selector);\\r\\n    };\\r\\n    DomUtils.copyToClipboard = function (str) {\\r\\n        var el = document.createElement(\\'textarea\\');\\r\\n        el.value = str;\\r\\n        document.body.appendChild(el);\\r\\n        el.select();\\r\\n        document.execCommand(\\'copy\\');\\r\\n        document.body.removeChild(el);\\r\\n    };\\r\\n    DomUtils.getBlobURL = function (code, type) {\\r\\n        var blob = new Blob([code], { type: type });\\r\\n        return URL.createObjectURL(blob);\\r\\n    };\\r\\n    DomUtils.getHtmlBlobUrl = function (code) {\\r\\n        return DomUtils.getBlobURL(code, \"text/html\");\\r\\n    };\\r\\n    DomUtils.removeAllChildren = function (el) {\\r\\n        while (el.firstChild) {\\r\\n            el.removeChild(el.firstChild);\\r\\n        }\\r\\n    };\\r\\n    /**\\r\\n     * Uses canvas.measureText to compute and return the width of the given text of given font in pixels.\\r\\n     *\\r\\n     * @param {String} text The text to be rendered.\\r\\n     * @param {String} fontCss The css font descriptor that text is to be rendered with (e.g. \"bold 14px verdana\").\\r\\n     *\\r\\n     * @see https://stackoverflow.com/questions/118241/calculate-text-width-with-javascript/21015393#21015393\\r\\n     */\\r\\n    DomUtils.getTextMetrics = function (text, fontCss) {\\r\\n        // re-use canvas object for better performance\\r\\n        if (DomUtils.canvas == null) {\\r\\n            DomUtils.canvas = document.createElement(\"canvas\");\\r\\n        }\\r\\n        var context = DomUtils.canvas.getContext(\"2d\");\\r\\n        context.font = fontCss;\\r\\n        return context.measureText(text);\\r\\n    };\\r\\n    DomUtils.getTextWidth = function (text, fontCss) {\\r\\n        return DomUtils.getTextMetrics(text, fontCss).width;\\r\\n    };\\r\\n    DomUtils.isFullScreenEnabled = function () {\\r\\n        return document.fullscreenEnabled ||\\r\\n            // @ts-ignore\\r\\n            document.webkitFullscreenEnabled ||\\r\\n            // @ts-ignore\\r\\n            document.mozFullScreenEnabled ||\\r\\n            // @ts-ignore\\r\\n            document.msFullscreenEnabled;\\r\\n    };\\r\\n    DomUtils.closest = function (child, selector) {\\r\\n        var next = child;\\r\\n        var i = 0;\\r\\n        do {\\r\\n            if (next == null)\\r\\n                return null;\\r\\n            if (DomUtils.matches(next, selector))\\r\\n                return next;\\r\\n            next = next.parentElement;\\r\\n        } while (i++ < 10000);\\r\\n        console.warn(\" \" + i + \" loops - check code for errors!\");\\r\\n    };\\r\\n    DomUtils.prepend = function (parent, child) {\\r\\n        parent.insertBefore(child, parent.firstChild);\\r\\n    };\\r\\n    return DomUtils;\\r\\n}());\\r\\nexports.DomUtils = DomUtils;\\r\\n/******\\r\\n *  Polyfills\\r\\n *****/\\r\\nvar matches = Element.prototype.matches ||\\r\\n    // @ts-ignore\\r\\n    Element.prototype.matchesSelector ||\\r\\n    Element.prototype.webkitMatchesSelector ||\\r\\n    // @ts-ignore\\r\\n    Element.prototype.mozMatchesSelector ||\\r\\n    // @ts-ignore\\r\\n    Element.prototype.msMatchesSelector;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/app-core/DomUtils.ts?')},\"./wonder-format/ts/app-core/EventBus.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar Task_1 = __webpack_require__(/*! ./Task */ \"./wonder-format/ts/app-core/Task.ts\");\\r\\nvar ArrayUtils_1 = __webpack_require__(/*! ./ArrayUtils */ \"./wonder-format/ts/app-core/ArrayUtils.ts\");\\r\\n/***\\r\\n *  Использование\\r\\n *  подписаться на сообщения\\r\\n *  EventBus\\r\\n *      .sub(\"messageType1\", (message, data)=>{})\\r\\n *      .sub(\"messageType2\", (message, data)=>{})\\r\\n *      .sub(\"messageType3\", (message, data)=>{});\\r\\n *\\r\\n *  сообщить\\r\\n *  EventBus.emit(\"messageType1\", data?:any);\\r\\n *\\r\\n *  для использования в конкретных играх - уместно объявить класс-потомкс уникальным именем\\r\\n *  типа MyGameEvents\\r\\n *  и использовать именно MyGameEvents\\r\\n */\\r\\nvar EventBus = /** @class */ (function () {\\r\\n    function EventBus() {\\r\\n        this.listeners = {};\\r\\n    }\\r\\n    EventBus.prototype.getListeners = function (message) {\\r\\n        return this.listeners[message];\\r\\n    };\\r\\n    EventBus.prototype.initListeners = function (message) {\\r\\n        this.listeners[message] = [];\\r\\n        return this.listeners[message];\\r\\n    };\\r\\n    EventBus.getInstance = function () {\\r\\n        if (EventBus.instance == null)\\r\\n            EventBus.instance = new EventBus();\\r\\n        return EventBus.instance;\\r\\n    };\\r\\n    EventBus.addListener = function (message, listener) {\\r\\n        var listeners = EventBus.getInstance().getListeners(message)\\r\\n            || EventBus.getInstance().initListeners(message);\\r\\n        listeners.push(listener);\\r\\n    };\\r\\n    EventBus.prototype.sub = function (message, listener) {\\r\\n        var listeners = this.getListeners(message) || this.initListeners(message);\\r\\n        listeners.push(listener);\\r\\n        return this;\\r\\n    };\\r\\n    EventBus.prototype.unsub = function (message, listener) {\\r\\n        var listeners = this.getListeners(message);\\r\\n        if (listeners == null)\\r\\n            return;\\r\\n        ArrayUtils_1.ArrayUtils.removeChild(listeners, listener);\\r\\n        return this;\\r\\n    };\\r\\n    EventBus.emit = function (message, data) {\\r\\n        var listeners = EventBus.getInstance().getListeners(message);\\r\\n        if (listeners)\\r\\n            listeners.forEach(function (listener) {\\r\\n                /**\\r\\n                 * каждый листенер исполняется в свою очередь в EventLoop\\r\\n                 * - поэтому ошибка в одном листенере не будет ломать стек с другими\\r\\n                 *  - поэтому ошибка 1 листенера не будет ломать остальные\\r\\n                 */\\r\\n                Task_1.Task.order(function () {\\r\\n                    listener(message, data);\\r\\n                });\\r\\n            });\\r\\n    };\\r\\n    return EventBus;\\r\\n}());\\r\\nexports.EventBus = EventBus;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/app-core/EventBus.ts?')},\"./wonder-format/ts/app-core/Task.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar orderTask = requestAnimationFrame\\r\\n    ? function (fn) { return requestAnimationFrame(fn); }\\r\\n    : function (fn) { return setTimeout(fn, 0); };\\r\\nexports.Task = {\\r\\n    order: orderTask // заказать выполнение функции на следующий цикл EventLoop\\r\\n};\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/app-core/Task.ts?')},\"./wonder-format/ts/parser/FormatTwinePassageAsHTML.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar Constants_1 = __webpack_require__(/*! ../Constants */ \"./wonder-format/ts/Constants.ts\");\\r\\nfunction formatTwinePassageAsHTML(content, template) {\\r\\n    console.log(\"twinePassageFormatter....\", template);\\r\\n    var MARKER = Constants_1.WONDER.template;\\r\\n    // 1. вынимаем из шаблона шаблон линков\\r\\n    var linkTemplate = innerTexts(template, MARKER.choiceStart, MARKER.choiceEnd)[0];\\r\\n    template = template\\r\\n        .replace(linkTemplate, MARKER.choiceText)\\r\\n        .replace(MARKER.choiceStart, \\'\\')\\r\\n        .replace(MARKER.choiceEnd, \\'\\');\\r\\n    // 2. традиционные линки\\r\\n    content = content.replace(Constants_1.REGEXP.twineLink, function (match, catched) {\\r\\n        catched = catched.trim();\\r\\n        // линки могут быть встроенные или с новой строки\\r\\n        var isInline = catched[0] == Constants_1.WONDER.inlineStart;\\r\\n        if (isInline) {\\r\\n            catched = catched.substring(1);\\r\\n        }\\r\\n        var TEMPLATE = isInline ? Constants_1.LINK_INLINE_TEMPLATE : Constants_1.LINK_TEMPLATE;\\r\\n        var link = buildLink(catched);\\r\\n        return getLinkHtml(link, TEMPLATE); // чистим\\r\\n    })\\r\\n        .trim();\\r\\n    // переводы строк в br\\r\\n    content = content.replace(/(?:\\\\r\\\\n|\\\\r|\\\\n)/g, \\'<br>\\');\\r\\n    // 99. вставляем текст\\r\\n    var code = template;\\r\\n    code = code.replace(MARKER.text, content.trim());\\r\\n    return code;\\r\\n}\\r\\nexports.formatTwinePassageAsHTML = formatTwinePassageAsHTML;\\r\\n/**\\r\\n * @param source - строка вида Зайти в лавку гоблина|goblin\\r\\n */\\r\\nfunction buildLink(source) {\\r\\n    var parts = source.split(\"|\");\\r\\n    parts[0] = parts[0].trim();\\r\\n    if (parts[1] == undefined)\\r\\n        parts[1] = parts[0];\\r\\n    return new Link(parts[0], parts[1]);\\r\\n}\\r\\nfunction getLinkHtml(link, linkTemplate) {\\r\\n    var code = linkTemplate\\r\\n        .replace(Constants_1.WONDER.template.choiceId, link.id)\\r\\n        .replace(Constants_1.WONDER.template.choiceText, link.text);\\r\\n    return code;\\r\\n}\\r\\nvar Link = /** @class */ (function () {\\r\\n    function Link(text, id) {\\r\\n        this.text = text;\\r\\n        this.id = id;\\r\\n    }\\r\\n    return Link;\\r\\n}());\\r\\n/**\\r\\n * Вернуть массив строк, которые находятся между двумя тегами/кусками текста\\r\\n * @method innerTexts\\r\\n * @param {string} str  исходная строка\\r\\n * @param {string} startTag\\r\\n * @param {string} endTag\\r\\n * @return {Array}\\r\\n */\\r\\nfunction innerTexts(str, startTag, endTag) {\\r\\n    var subStrings = [];\\r\\n    var offset = 0;\\r\\n    var startIndex, endIndex;\\r\\n    while (offset < str.length) {\\r\\n        startIndex = str.indexOf(startTag, offset);\\r\\n        if (startIndex === -1)\\r\\n            return subStrings;\\r\\n        endIndex = str.indexOf(endTag, startIndex);\\r\\n        if (endIndex === -1)\\r\\n            endIndex = undefined;\\r\\n        subStrings.push(str.substring(startIndex + startTag.length, endIndex));\\r\\n        offset = endIndex + endTag.length;\\r\\n    }\\r\\n    return subStrings;\\r\\n}\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/parser/FormatTwinePassageAsHTML.ts?')},\"./wonder-format/ts/parser/TwineParser.ts\":function(module,exports,__webpack_require__){\"use strict\";eval(\"\\r\\nObject.defineProperty(exports, \\\"__esModule\\\", { value: true });\\r\\nfunction parseTwineData() {\\r\\n    var storyEl = document.body.querySelector('tw-storydata');\\r\\n    var story = elAttributesToObject(storyEl);\\r\\n    story.style = document.querySelector('#twine-user-stylesheet').innerHTML.trim();\\r\\n    story.script = document.querySelector('#twine-user-script').innerHTML.trim();\\r\\n    var passageArray = Array.prototype.slice.call(storyEl.querySelectorAll('tw-passagedata'));\\r\\n    story.passageHash = {};\\r\\n    story.passages = passageArray.map(function (passageEl) {\\r\\n        var passage = elAttributesToObject(passageEl);\\r\\n        if (story.passageHash[passage.pid]) {\\r\\n            console.warn(\\\"duplicate passage id \\\" + passage.pid);\\r\\n        }\\r\\n        story.passageHash[passage.name] = passage;\\r\\n        if (story.startnode == passage.pid) {\\r\\n            story.startPassageName = passage.name;\\r\\n        }\\r\\n        passage.content = htmlDecode(passageEl.innerHTML.trim());\\r\\n        return passage;\\r\\n    });\\r\\n    return story;\\r\\n}\\r\\nexports.parseTwineData = parseTwineData;\\r\\nfunction htmlDecode(input) {\\r\\n    var e = document.createElement('textarea');\\r\\n    e.innerHTML = input;\\r\\n    return e.childNodes.length === 0 ? \\\"\\\" : e.childNodes[0].nodeValue;\\r\\n}\\r\\n// convert attributes to fields\\r\\nfunction elAttributesToObject(el) {\\r\\n    var obj = {};\\r\\n    for (var i = 0, attrs = el.attributes, n = attrs.length; i < n; i++) {\\r\\n        obj[kebabToCamel(attrs[i].name)] = attrs[i].value;\\r\\n    }\\r\\n    return obj;\\r\\n}\\r\\nfunction kebabToCamel(str) {\\r\\n    var arr = str.split('-');\\r\\n    var capital = arr.map(function (item, index) { return index ? item.charAt(0).toUpperCase() + item.slice(1).toLowerCase() : item; });\\r\\n    // ^-- change here.\\r\\n    var capitalString = capital.join(\\\"\\\");\\r\\n    return capitalString;\\r\\n}\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/parser/TwineParser.ts?\")},\"./wonder-format/ts/runtime/AudioPlayer.ts\":function(module,exports,__webpack_require__){\"use strict\";eval(\"\\r\\nObject.defineProperty(exports, \\\"__esModule\\\", { value: true });\\r\\n/*************\\r\\n *  Audio\\r\\n ***********/\\r\\nvar AudioPlayer = /** @class */ (function () {\\r\\n    function AudioPlayer() {\\r\\n        this.musicHash = {};\\r\\n        this.audioElement = new Audio();\\r\\n    }\\r\\n    AudioPlayer.prototype.music = function (url, volume) {\\r\\n        this.audioElement.loop = true;\\r\\n        this.play(url, volume);\\r\\n    };\\r\\n    AudioPlayer.prototype.sound = function (url, volume) {\\r\\n        this.audioElement.loop = false;\\r\\n        this.play(url, volume);\\r\\n    };\\r\\n    AudioPlayer.prototype.musicFor = function (hashName, url, volume) {\\r\\n        this.musicHash[hashName] = { url: url, volume: volume };\\r\\n    };\\r\\n    AudioPlayer.prototype.musicCheck = function (hashName) {\\r\\n        var sound = this.musicHash[hashName];\\r\\n        if (sound == null)\\r\\n            return;\\r\\n        this.music(sound.url, sound.volume);\\r\\n    };\\r\\n    AudioPlayer.prototype.play = function (url, volume) {\\r\\n        var soundUrl = url.trim();\\r\\n        this.lastUrl = soundUrl;\\r\\n        this.audioElement.src = this.lastUrl;\\r\\n        this.audioElement.volume = volume;\\r\\n        if (!this.audioElement.paused && soundUrl == this.lastUrl)\\r\\n            return;\\r\\n        this.audioElement.play().then(function (value) { return console.log('play Then', value); });\\r\\n    };\\r\\n    AudioPlayer.prototype.stop = function () {\\r\\n        this.audioElement.pause();\\r\\n    };\\r\\n    return AudioPlayer;\\r\\n}());\\r\\nexports.AudioPlayer = AudioPlayer;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/runtime/AudioPlayer.ts?\")},\"./wonder-format/ts/runtime/PostMessageApi.ts\":function(module,exports,__webpack_require__){\"use strict\";eval(\"\\r\\nObject.defineProperty(exports, \\\"__esModule\\\", { value: true });\\r\\nvar PostMessageApi = /** @class */ (function () {\\r\\n    function PostMessageApi(parent, targetOrigin) {\\r\\n        var _this = this;\\r\\n        if (parent === void 0) { parent = null; }\\r\\n        if (targetOrigin === void 0) { targetOrigin = \\\"*\\\"; }\\r\\n        this.isDisabled = true;\\r\\n        this.listenerMap = {};\\r\\n        this.parent = parent;\\r\\n        if (this.parent == null) {\\r\\n            this.parent = window.parent;\\r\\n        }\\r\\n        this.targetOrigin = targetOrigin;\\r\\n        window.addEventListener('message', function (e) { return _this.onMessage(e); });\\r\\n    }\\r\\n    PostMessageApi.prototype.enable = function () {\\r\\n        this.isDisabled = false;\\r\\n    };\\r\\n    PostMessageApi.prototype.disable = function () {\\r\\n        this.isDisabled = true;\\r\\n    };\\r\\n    PostMessageApi.prototype.send = function (messageName, data) {\\r\\n        if (this.isDisabled)\\r\\n            return;\\r\\n        var postMessage = {\\r\\n            name: messageName,\\r\\n            data: data\\r\\n        };\\r\\n        if (this.parent) {\\r\\n            this.parent.postMessage(postMessage, this.targetOrigin);\\r\\n        }\\r\\n        else {\\r\\n            console.warn('PostMessageAPI.send:  no window parent');\\r\\n        }\\r\\n    };\\r\\n    PostMessageApi.prototype.on = function (messageName, listener) {\\r\\n        if (this.listenerMap[messageName] == null) {\\r\\n            this.listenerMap[messageName] = [];\\r\\n        }\\r\\n        this.listenerMap[messageName].push(listener);\\r\\n    };\\r\\n    PostMessageApi.prototype.onMessage = function (e) {\\r\\n        if (this.isDisabled)\\r\\n            return;\\r\\n        var postMessage = e.data;\\r\\n        var listeners = this.listenerMap[postMessage.name];\\r\\n        if (listeners) {\\r\\n            listeners.forEach(function (listener) { return listener(postMessage.data); });\\r\\n        }\\r\\n        else {\\r\\n            console.warn('PostMessageAPI.onMessage:  no listeners for', postMessage.name);\\r\\n            console.warn('MessageEvent: ', e);\\r\\n        }\\r\\n    };\\r\\n    return PostMessageApi;\\r\\n}());\\r\\nexports.PostMessageApi = PostMessageApi;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/runtime/PostMessageApi.ts?\")},\"./wonder-format/ts/runtime/RunTime.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nvar __assign = (this && this.__assign) || function () {\\r\\n    __assign = Object.assign || function(t) {\\r\\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\\r\\n            s = arguments[i];\\r\\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\\r\\n                t[p] = s[p];\\r\\n        }\\r\\n        return t;\\r\\n    };\\r\\n    return __assign.apply(this, arguments);\\r\\n};\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar PostMessageApi_1 = __webpack_require__(/*! ./PostMessageApi */ \"./wonder-format/ts/runtime/PostMessageApi.ts\");\\r\\nvar Collections_1 = __webpack_require__(/*! ./collections/Collections */ \"./wonder-format/ts/runtime/collections/Collections.ts\");\\r\\nvar AudioPlayer_1 = __webpack_require__(/*! ./AudioPlayer */ \"./wonder-format/ts/runtime/AudioPlayer.ts\");\\r\\nvar SaveApi_1 = __webpack_require__(/*! ./saveapi/SaveApi */ \"./wonder-format/ts/runtime/saveapi/SaveApi.ts\");\\r\\nvar Stores_1 = __webpack_require__(/*! ../twine-game/Stores */ \"./wonder-format/ts/twine-game/Stores.ts\");\\r\\nvar RunTime = /** @class */ (function () {\\r\\n    function RunTime() {\\r\\n        var _this = this;\\r\\n        this.autosave = this.autoSave;\\r\\n        this.gameVars = {};\\r\\n        this.audioPlayer = new AudioPlayer_1.AudioPlayer();\\r\\n        this.collections = new Collections_1.Collections();\\r\\n        this.postMessageApi = new PostMessageApi_1.PostMessageApi();\\r\\n        this.saveApi = new SaveApi_1.SaveApi();\\r\\n        // enable parent API load if enabled\\r\\n        this.postMessageApi.on(\"load\" /* load */, function (state) {\\r\\n            _this.saveApi.loadFrom(state);\\r\\n        });\\r\\n        // set saveApi data source\\r\\n        this.saveApi.dataGetter = function () {\\r\\n            console.log(\\'get STORE.state \\', Stores_1.STORE.state);\\r\\n            return Stores_1.STORE.state;\\r\\n        };\\r\\n    }\\r\\n    RunTime.prototype.onStateLoad = function (listener) {\\r\\n        this.saveApi.dataHandler = listener;\\r\\n    };\\r\\n    RunTime.prototype.getGameVars = function () {\\r\\n        return this.gameVars;\\r\\n    };\\r\\n    RunTime.prototype.setGameVars = function (gameVars) {\\r\\n        this.gameVars = __assign({}, gameVars);\\r\\n    };\\r\\n    RunTime.prototype.updateGameVars = function (gameVars) {\\r\\n        this.gameVars = __assign(__assign({}, this.gameVars), gameVars);\\r\\n    };\\r\\n    /**************\\r\\n     *  STATE\\r\\n     *************/\\r\\n    RunTime.prototype.setState = function (state) {\\r\\n        if (state == null)\\r\\n            return;\\r\\n        this.setGameVars(state.gameVars);\\r\\n        this.collections.loadState(state.collections);\\r\\n    };\\r\\n    RunTime.prototype.getState = function () {\\r\\n        return {\\r\\n            gameVars: this.gameVars,\\r\\n            collections: this.collections.getState()\\r\\n        };\\r\\n    };\\r\\n    /***********\\r\\n     *  Стили, дизайн\\r\\n     **********/\\r\\n    /************\\r\\n     *  Подключить стиль\\r\\n     ***********/\\r\\n    RunTime.prototype.styleUrl = function (styleUrl) {\\r\\n        var styleEl = document.createElement(\\'link\\');\\r\\n        styleEl.setAttribute(\\'rel\\', \\'stylesheet\\');\\r\\n        styleEl.setAttribute(\\'href\\', styleUrl);\\r\\n        document.head.appendChild(styleEl);\\r\\n    };\\r\\n    /************\\r\\n     *  Подключить js\\r\\n     ***********/\\r\\n    RunTime.prototype.jsUrl = function (jsUrl, callback) {\\r\\n        var script = document.createElement(\"script\");\\r\\n        script.type = \"text/javascript\";\\r\\n        if (callback) {\\r\\n            script.onload = function () {\\r\\n                callback();\\r\\n            };\\r\\n        }\\r\\n        script.src = jsUrl;\\r\\n        document.head.appendChild(script);\\r\\n    };\\r\\n    /********************\\r\\n     *  Collectibles\\r\\n     *******************/\\r\\n    RunTime.prototype.collect = function (rule) {\\r\\n        this.collections.addRule(rule);\\r\\n    };\\r\\n    /***********\\r\\n     *  Sounds\\r\\n     **********/\\r\\n    RunTime.prototype.music = function (url, volume) {\\r\\n        if (volume === void 0) { volume = 1; }\\r\\n        this.audioPlayer.music(url, volume);\\r\\n    };\\r\\n    RunTime.prototype.musicFor = function (hashName, url, volume) {\\r\\n        if (volume === void 0) { volume = 1; }\\r\\n        this.audioPlayer.musicFor(hashName, url, volume);\\r\\n    };\\r\\n    RunTime.prototype.sound = function (url, volume) {\\r\\n        if (volume === void 0) { volume = 1; }\\r\\n        this.audioPlayer.sound(url, volume);\\r\\n    };\\r\\n    RunTime.prototype.musicStop = function () {\\r\\n        this.audioPlayer.stop();\\r\\n    };\\r\\n    /********************\\r\\n     *  postMessageApi\\r\\n     *******************/\\r\\n    RunTime.prototype.parentApi = function () {\\r\\n        return this.postMessageApi;\\r\\n    };\\r\\n    /********************\\r\\n     *  save/load\\r\\n     *******************/\\r\\n    // для отключения, если работаем с внешним API, к примеру\\r\\n    RunTime.prototype.disableLocalSave = function (disable) {\\r\\n        if (disable === void 0) { disable = true; }\\r\\n        this.saveApi.disable(disable);\\r\\n    };\\r\\n    RunTime.prototype.autoSave = function (enabled) {\\r\\n        if (enabled === void 0) { enabled = true; }\\r\\n        this.saveApi.autoSave(enabled);\\r\\n    };\\r\\n    RunTime.prototype.saveSlot = function (saveName) {\\r\\n        this.saveApi.saveSlot(saveName);\\r\\n    };\\r\\n    RunTime.prototype.save = function (saveName) {\\r\\n        this.parentApi().send(\"passage\" /* passage */, Stores_1.STORE.state);\\r\\n        this.saveApi.save(saveName);\\r\\n    };\\r\\n    RunTime.prototype.load = function (saveName) {\\r\\n        this.saveApi.load(saveName);\\r\\n    };\\r\\n    /***********\\r\\n     *  методы вызываются основным движком\\r\\n     **********/\\r\\n    RunTime.prototype.onStoryReady = function () {\\r\\n        var _this = this;\\r\\n        console.log(\\'Wonder onStoryReady\\');\\r\\n        // поскольку подсчет коллекций может быть долгим, откладываем ненадолго\\r\\n        setTimeout(function () {\\r\\n            _this.collections.onStoryReady();\\r\\n        }, 0);\\r\\n    };\\r\\n    RunTime.prototype.onPassage = function (passage, state) {\\r\\n        this.audioPlayer.musicCheck(passage.name);\\r\\n        this.collections.onPassage(passage);\\r\\n        this.saveApi.onPassage();\\r\\n    };\\r\\n    return RunTime;\\r\\n}());\\r\\nexports.RunTime = RunTime;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/runtime/RunTime.ts?')},\"./wonder-format/ts/runtime/collections/Collections.ts\":function(module,exports,__webpack_require__){\"use strict\";eval(\"\\r\\nvar __assign = (this && this.__assign) || function () {\\r\\n    __assign = Object.assign || function(t) {\\r\\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\\r\\n            s = arguments[i];\\r\\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\\r\\n                t[p] = s[p];\\r\\n        }\\r\\n        return t;\\r\\n    };\\r\\n    return __assign.apply(this, arguments);\\r\\n};\\r\\nObject.defineProperty(exports, \\\"__esModule\\\", { value: true });\\r\\nvar CollectionsView_1 = __webpack_require__(/*! ./CollectionsView */ \\\"./wonder-format/ts/runtime/collections/CollectionsView.ts\\\");\\r\\nvar Stores_1 = __webpack_require__(/*! ../../twine-game/Stores */ \\\"./wonder-format/ts/twine-game/Stores.ts\\\");\\r\\n/*************\\r\\n *  Collectables\\r\\n ***********/\\r\\nvar Collections = /** @class */ (function () {\\r\\n    function Collections() {\\r\\n        this.rulesMap = {};\\r\\n        this.collectionMap = {};\\r\\n        this.collectionsView = new CollectionsView_1.CollectionsView();\\r\\n    }\\r\\n    Collections.prototype.onStoryReady = function () {\\r\\n        var _this = this;\\r\\n        this.initCollections();\\r\\n        setTimeout(function () {\\r\\n            _this.collectionsView.createViews(_this.collectionMap);\\r\\n        }, 500);\\r\\n    };\\r\\n    Collections.prototype.loadState = function (state) {\\r\\n        this.collectionMap = __assign(__assign({}, this.collectionMap), state.collected);\\r\\n        this.collectionsView.updateButtons(this.collectionMap);\\r\\n    };\\r\\n    Collections.prototype.getState = function () {\\r\\n        return {\\r\\n            collected: this.collectionMap\\r\\n        };\\r\\n    };\\r\\n    // следует добавлять только в пользовательском скрипте или раньше\\r\\n    Collections.prototype.addRule = function (rule) {\\r\\n        var _this = this;\\r\\n        console.log('Collections.addRule for ', rule.tags);\\r\\n        rule.tags.forEach(function (tag) {\\r\\n            if (_this.rulesMap[tag] == null) {\\r\\n                _this.rulesMap[tag] = [];\\r\\n            }\\r\\n            _this.rulesMap[tag].push(rule);\\r\\n        });\\r\\n        this.addCollection(rule);\\r\\n    };\\r\\n    Collections.prototype.onPassage = function (passage) {\\r\\n        var _this = this;\\r\\n        var pTags = this.getTags(passage);\\r\\n        pTags.forEach(function (tag) { return _this.collectTag(tag, passage); });\\r\\n    };\\r\\n    /**************\\r\\n     * private\\r\\n     *************/\\r\\n    Collections.prototype.collectTag = function (passageTag, passage) {\\r\\n        var _this = this;\\r\\n        var rules = this.rulesMap[passageTag];\\r\\n        if (rules == null || rules.length < 1)\\r\\n            return;\\r\\n        rules.forEach(function (rule) { return _this.collectByRule(rule, passage); });\\r\\n    };\\r\\n    Collections.prototype.collectByRule = function (rule, passage) {\\r\\n        var collection = this.collectionMap[rule.collection];\\r\\n        if (collection.collected.indexOf(passage.name) < 0) {\\r\\n            collection.collected.push(passage.name);\\r\\n            this.onPassageCollected(passage, collection);\\r\\n        }\\r\\n    };\\r\\n    Collections.prototype.onPassageCollected = function (passage, collection) {\\r\\n        this.collectionsView.updateButton(collection);\\r\\n    };\\r\\n    Collections.prototype.addCollection = function (rule) {\\r\\n        if (this.collectionMap[rule.collection] != null) {\\r\\n            console.warn('addCollection with same name ', rule.collection);\\r\\n        }\\r\\n        this.collectionMap[rule.collection] = {\\r\\n            name: rule.collection,\\r\\n            title: rule.title,\\r\\n            collected: [],\\r\\n            maxAmount: 0\\r\\n        };\\r\\n    };\\r\\n    Collections.prototype.initCollections = function () {\\r\\n        var _this = this;\\r\\n        var story = Stores_1.STORY_STORE.story;\\r\\n        // защита от загрузки\\r\\n        Object.keys(this.collectionMap).forEach(function (cName) {\\r\\n            _this.collectionMap[cName].maxAmount = 0;\\r\\n        });\\r\\n        story.passages.forEach(function (passage) {\\r\\n            var pTags = _this.getTags(passage);\\r\\n            pTags.forEach(function (tag) {\\r\\n                var rules = _this.rulesMap[tag];\\r\\n                if (rules == null)\\r\\n                    return;\\r\\n                rules.forEach(function (rule) {\\r\\n                    var collection = _this.collectionMap[rule.collection];\\r\\n                    if (collection == null) {\\r\\n                        console.warn('collection==null for', rule.collection);\\r\\n                        return;\\r\\n                    }\\r\\n                    // есть rule, подходящее под tag текущего пассажа?\\r\\n                    // добавляем +1 к счетчик коллекции\\r\\n                    collection.maxAmount++;\\r\\n                });\\r\\n            });\\r\\n        });\\r\\n    };\\r\\n    Collections.prototype.getTags = function (passage) {\\r\\n        return passage.tags.split(' ');\\r\\n    };\\r\\n    return Collections;\\r\\n}());\\r\\nexports.Collections = Collections;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/runtime/collections/Collections.ts?\")},\"./wonder-format/ts/runtime/collections/CollectionsView.ts\":function(module,exports,__webpack_require__){\"use strict\";eval(\"\\r\\nObject.defineProperty(exports, \\\"__esModule\\\", { value: true });\\r\\nvar SingleCollectionView_1 = __webpack_require__(/*! ./SingleCollectionView */ \\\"./wonder-format/ts/runtime/collections/SingleCollectionView.ts\\\");\\r\\nvar DomUtils_1 = __webpack_require__(/*! ../../app-core/DomUtils */ \\\"./wonder-format/ts/app-core/DomUtils.ts\\\");\\r\\nvar CollectionsView = /** @class */ (function () {\\r\\n    function CollectionsView() {\\r\\n        var _this = this;\\r\\n        this.isViewCreated = false;\\r\\n        this.viewMap = {};\\r\\n        this.buttonWrapper = document.createElement('div');\\r\\n        this.buttonWrapper.id = \\\"c-wrapper\\\" /* wrapperId */;\\r\\n        this.buttonWrapper.addEventListener('mouseup', function (event) { return _this.findButton(event); });\\r\\n        this.shadow = document.createElement('div');\\r\\n        this.shadow.id = \\\"c-shadow\\\" /* shadowId */;\\r\\n        this.shadow.style.display = 'none';\\r\\n        this.shadow.style.position = 'absolute';\\r\\n        this.shadow.style.width = '100%';\\r\\n        this.shadow.style.height = '100%';\\r\\n        this.shadow.style.background = '#000';\\r\\n        this.shadow.style.opacity = '0.3';\\r\\n        this.shadow.addEventListener('mouseup', function (event) { return _this.closeAll(); });\\r\\n    }\\r\\n    CollectionsView.prototype.createViews = function (collectionMap) {\\r\\n        var _this = this;\\r\\n        document.body.appendChild(this.shadow);\\r\\n        Object.keys(collectionMap).forEach(function (collectionName) {\\r\\n            var collection = collectionMap[collectionName];\\r\\n            var view = new SingleCollectionView_1.SingleCollectionView();\\r\\n            _this.viewMap[collectionName] = view;\\r\\n            view.update(collection);\\r\\n            view.onCollectionShow(function (collectionName) { return _this.onCollectionShow(collectionName); });\\r\\n            view.attach(_this.buttonWrapper);\\r\\n        });\\r\\n        this.isViewCreated = true;\\r\\n        document.body.appendChild(this.buttonWrapper);\\r\\n    };\\r\\n    CollectionsView.prototype.updateButtons = function (collectionMap) {\\r\\n        var _this = this;\\r\\n        Object.keys(collectionMap).forEach(function (collectionName) {\\r\\n            var collection = collectionMap[collectionName];\\r\\n            _this.updateButton(collection);\\r\\n        });\\r\\n    };\\r\\n    CollectionsView.prototype.updateButton = function (collection) {\\r\\n        if (!this.isViewCreated)\\r\\n            return;\\r\\n        var view = this.viewMap[collection.name];\\r\\n        if (view == null) {\\r\\n            console.warn('CollectionsView.updateButton: cannot find ', collection.name);\\r\\n            return;\\r\\n        }\\r\\n        view.update(collection);\\r\\n    };\\r\\n    /**\\r\\n     *  PRIVATE\\r\\n     */\\r\\n    CollectionsView.prototype.onCollectionShow = function (collectionName) {\\r\\n        var _this = this;\\r\\n        Object.keys(this.viewMap).forEach(function (nextCollectionName) {\\r\\n            if (collectionName != nextCollectionName) {\\r\\n                _this.viewMap[nextCollectionName].closeCollection();\\r\\n            }\\r\\n        });\\r\\n    };\\r\\n    CollectionsView.prototype.findButton = function (e) {\\r\\n        var _this = this;\\r\\n        var button = DomUtils_1.DomUtils.closest(e.target, \\\".\\\" + \\\"c-button\\\" /* button */);\\r\\n        if (button) {\\r\\n            var collectionName_1 = button.dataset.collection;\\r\\n            console.log('findButton ', collectionName_1);\\r\\n            Object.keys(this.viewMap).forEach(function (name) {\\r\\n                var view = _this.viewMap[name];\\r\\n                if (view == null) {\\r\\n                    console.warn('Collections.findButton - null view', collectionName_1);\\r\\n                    return;\\r\\n                }\\r\\n                if (name == collectionName_1) {\\r\\n                    _this.shadow.style.display = 'block';\\r\\n                    view.showCollection();\\r\\n                }\\r\\n                else\\r\\n                    view.closeCollection();\\r\\n            });\\r\\n        }\\r\\n    };\\r\\n    CollectionsView.prototype.closeAll = function () {\\r\\n        var _this = this;\\r\\n        Object.keys(this.viewMap).forEach(function (name) {\\r\\n            _this.viewMap[name].closeCollection();\\r\\n        });\\r\\n        this.shadow.style.display = 'none';\\r\\n    };\\r\\n    return CollectionsView;\\r\\n}());\\r\\nexports.CollectionsView = CollectionsView;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/runtime/collections/CollectionsView.ts?\")},\"./wonder-format/ts/runtime/collections/SingleCollectionView.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar Stores_1 = __webpack_require__(/*! ../../twine-game/Stores */ \"./wonder-format/ts/twine-game/Stores.ts\");\\r\\nvar FormatTwinePassageAsHTML_1 = __webpack_require__(/*! ../../parser/FormatTwinePassageAsHTML */ \"./wonder-format/ts/parser/FormatTwinePassageAsHTML.ts\");\\r\\nvar Constants_1 = __webpack_require__(/*! ../../Constants */ \"./wonder-format/ts/Constants.ts\");\\r\\nvar DomUtils_1 = __webpack_require__(/*! ../../app-core/DomUtils */ \"./wonder-format/ts/app-core/DomUtils.ts\");\\r\\nvar SingleCollectionView = /** @class */ (function () {\\r\\n    function SingleCollectionView(buttonClass, listClass, pageClass) {\\r\\n        if (buttonClass === void 0) { buttonClass = \"c-button\" /* button */; }\\r\\n        if (listClass === void 0) { listClass = \"c-list\" /* list */; }\\r\\n        if (pageClass === void 0) { pageClass = \"c-page\" /* page */; }\\r\\n        this.buttonClass = buttonClass;\\r\\n        this.listClass = listClass;\\r\\n        this.pageClass = pageClass;\\r\\n        this.buttonEl = this.createButton(buttonClass);\\r\\n        this.listEl = this.createList(listClass);\\r\\n        this.pageEl = this.createPage(pageClass);\\r\\n    }\\r\\n    SingleCollectionView.prototype.attach = function (el) {\\r\\n        el = el || document.body;\\r\\n        document.body.appendChild(this.listEl);\\r\\n        document.body.appendChild(this.pageEl);\\r\\n        el.appendChild(this.buttonEl);\\r\\n    };\\r\\n    SingleCollectionView.prototype.update = function (collection) {\\r\\n        this.updateButton(collection);\\r\\n        this.updateListTitle(collection);\\r\\n        this.updateList(collection);\\r\\n    };\\r\\n    SingleCollectionView.prototype.onCollectionShow = function (callback) {\\r\\n        this.onButtonClickCallback = callback;\\r\\n    };\\r\\n    /********************\\r\\n     *  create elements\\r\\n     *******************/\\r\\n    SingleCollectionView.prototype.createButton = function (className) {\\r\\n        var bt = this.createDiv(className);\\r\\n        this.buttonTitleEl = this.createDiv(\"c-bt-title\" /* buttonTitle */);\\r\\n        this.buttonContentEl = this.createDiv(\"c-bt-content\" /* buttonContent */);\\r\\n        bt.appendChild(this.buttonTitleEl);\\r\\n        bt.appendChild(this.buttonContentEl);\\r\\n        return bt;\\r\\n    };\\r\\n    SingleCollectionView.prototype.createList = function (className) {\\r\\n        var _this = this;\\r\\n        var list = this.createDiv(className);\\r\\n        list.addEventListener(\\'click\\', function (e) { return _this.findItem(e); });\\r\\n        //list.addEventListener(\\'mouseup\\', () => this.closeCollection());\\r\\n        this.listTitleEl = this.createDiv(\"c-list-title\" /* listTitle */);\\r\\n        this.listContentEl = this.createDiv(\"c-list-content\" /* listContent */);\\r\\n        list.appendChild(this.listTitleEl);\\r\\n        list.appendChild(this.listContentEl);\\r\\n        return list;\\r\\n    };\\r\\n    SingleCollectionView.prototype.createPage = function (className) {\\r\\n        var _this = this;\\r\\n        var page = this.createDiv(className);\\r\\n        page.addEventListener(\\'mouseup\\', function () { return _this.closePage(); });\\r\\n        return page;\\r\\n    };\\r\\n    /********************\\r\\n     *  UPDATE COLLECTION\\r\\n     *******************/\\r\\n    SingleCollectionView.prototype.updateButton = function (collection) {\\r\\n        var BT = this.buttonEl;\\r\\n        var TITLE = this.buttonTitleEl;\\r\\n        var CONTENT = this.buttonContentEl;\\r\\n        this.collectionName = collection.name;\\r\\n        var collected = collection.collected.length;\\r\\n        var total = collection.maxAmount;\\r\\n        var title = collection.title;\\r\\n        BT.dataset.collection = this.collectionName;\\r\\n        // content\\r\\n        TITLE.innerHTML = \"\" + title;\\r\\n        CONTENT.innerHTML = collected + \"/\" + total;\\r\\n        // class\\r\\n        var isCompleted = collected == total;\\r\\n        var completedClass = isCompleted\\r\\n            ? \"c-button-completed\" /* buttonCompleted */\\r\\n            : \\'\\';\\r\\n        BT.className = \"c-button\" /* button */ +\\r\\n            \\' \\' + this.collectionName +\\r\\n            \\' \\' + completedClass;\\r\\n    };\\r\\n    SingleCollectionView.prototype.updateListTitle = function (collection) {\\r\\n        this.listTitleEl.innerHTML = collection.title;\\r\\n    };\\r\\n    SingleCollectionView.prototype.updateList = function (collection) {\\r\\n        var _this = this;\\r\\n        var LIST = this.listEl;\\r\\n        var LIST_CONTENT = this.listContentEl;\\r\\n        // clear list\\r\\n        LIST_CONTENT.innerHTML = \\'\\';\\r\\n        // create code\\r\\n        var passageMap = Stores_1.STORY_STORE.story.passageHash;\\r\\n        var newList = \\'\\';\\r\\n        collection.collected.forEach(function (name) {\\r\\n            var passage = passageMap[name];\\r\\n            var title = _this.getPageTitle(passage.content);\\r\\n            var itemTemplate = _this.getItemTemplate(title, name);\\r\\n            newList += itemTemplate;\\r\\n        });\\r\\n        // fill list\\r\\n        LIST_CONTENT.innerHTML = newList;\\r\\n        // list classes\\r\\n        LIST.className = \"c-list\" /* list */ + \\' \\' + this.collectionName;\\r\\n    };\\r\\n    SingleCollectionView.prototype.updatePage = function (passage) {\\r\\n        var PAGE = this.pageEl;\\r\\n        // clear\\r\\n        PAGE.innerHTML = \\'\\';\\r\\n        // parse content\\r\\n        // чистим контент от возможных скриптов\\r\\n        var cleanedContent = passage.content.replace(Constants_1.REGEXP.exeScript, \\'\\');\\r\\n        var PAGE_TEMPLATE = Constants_1.PASSAGE_TEMPLATE;\\r\\n        var html = FormatTwinePassageAsHTML_1.formatTwinePassageAsHTML(cleanedContent, PAGE_TEMPLATE);\\r\\n        console.log(\\'updatePage\\', html, passage);\\r\\n        // fill list\\r\\n        PAGE.innerHTML = html;\\r\\n    };\\r\\n    /********************\\r\\n     *  SHOW LIST\\r\\n     *******************/\\r\\n    SingleCollectionView.prototype.showCollection = function () {\\r\\n        this.listEl.classList.add(\"c-list-show\" /* listShow */);\\r\\n        if (this.onCollectionShow)\\r\\n            this.onButtonClickCallback(this.collectionName);\\r\\n    };\\r\\n    SingleCollectionView.prototype.closeCollection = function () {\\r\\n        this.listEl.classList.remove(\"c-list-show\" /* listShow */);\\r\\n        this.closePage(); // если была открыта страница - убираем и её\\r\\n    };\\r\\n    /********************\\r\\n     *  FIND PAGE\\r\\n     *******************/\\r\\n    SingleCollectionView.prototype.findItem = function (e) {\\r\\n        var item = DomUtils_1.DomUtils.closest(e.target, \".\" + \"c-item\" /* listItem */);\\r\\n        if (item)\\r\\n            this.onItemClick(item.dataset.name);\\r\\n    };\\r\\n    SingleCollectionView.prototype.onItemClick = function (name) {\\r\\n        var passage = Stores_1.STORY_STORE.story.passageHash[name];\\r\\n        if (passage == name) {\\r\\n            console.warn(\\'SingleCollectionView.onItemClick: cannot find\\' + name);\\r\\n            return;\\r\\n        }\\r\\n        this.updatePage(passage);\\r\\n        this.showPage();\\r\\n    };\\r\\n    /********************\\r\\n     *  PARSE PAGE\\r\\n     *******************/\\r\\n    SingleCollectionView.prototype.getPageTitle = function (passageContent) {\\r\\n        var title = innerText(passageContent, \\'<h1>\\', \\'</h1>\\');\\r\\n        if (title == null || title.length == 0) {\\r\\n            title = getFirstLine(passageContent);\\r\\n            console.log(\\'getFirstLine\\', title);\\r\\n        }\\r\\n        return title;\\r\\n    };\\r\\n    /********************\\r\\n     *  SHOW PAGE\\r\\n     *******************/\\r\\n    SingleCollectionView.prototype.showPage = function () {\\r\\n        this.pageEl.classList.add(\"c-page-show\" /* pageShow */);\\r\\n    };\\r\\n    SingleCollectionView.prototype.closePage = function () {\\r\\n        this.pageEl.classList.remove(\"c-page-show\" /* pageShow */);\\r\\n    };\\r\\n    /********************\\r\\n     *  TEMPLATES\\r\\n     *******************/\\r\\n    SingleCollectionView.prototype.createDiv = function (className) {\\r\\n        var div = document.createElement(\\'div\\');\\r\\n        div.className = className;\\r\\n        return div;\\r\\n    };\\r\\n    SingleCollectionView.prototype.getItemTemplate = function (title, name) {\\r\\n        return \"<div class=\" + \"c-item\" /* listItem */ + \" data-name=\\\\\"\" + name + \"\\\\\">\" + title + \"</div>\";\\r\\n    };\\r\\n    return SingleCollectionView;\\r\\n}());\\r\\nexports.SingleCollectionView = SingleCollectionView;\\r\\n/**\\r\\n * Вернуть первую строку между двумя тегами/кусками текста\\r\\n * @method innerText\\r\\n * @param {string} str  исходная строка\\r\\n * @param {string} startTag\\r\\n * @param {string} endTag\\r\\n * @return {string}\\r\\n */\\r\\nfunction innerText(str, startTag, endTag, withTags) {\\r\\n    if (withTags === void 0) { withTags = false; }\\r\\n    var startIndex = str.indexOf(startTag);\\r\\n    if (startIndex < 0)\\r\\n        return \\'\\';\\r\\n    var endIndex = str.indexOf(endTag, startIndex);\\r\\n    var startOffset = withTags ? 0 : startTag.length;\\r\\n    var endOffset = withTags ? endTag.length : 0;\\r\\n    return str.substring(startIndex + startOffset, endIndex + endOffset);\\r\\n}\\r\\nfunction getFirstLine(str) {\\r\\n    var breakIndex = str.indexOf(\"\\\\n\");\\r\\n    // consider that there can be line without a break\\r\\n    if (breakIndex === -1) {\\r\\n        return str;\\r\\n    }\\r\\n    return str.substr(0, breakIndex);\\r\\n}\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/runtime/collections/SingleCollectionView.ts?')},\"./wonder-format/ts/runtime/saveapi/SaveApi.ts\":function(module,exports,__webpack_require__){\"use strict\";eval(\"\\r\\nObject.defineProperty(exports, \\\"__esModule\\\", { value: true });\\r\\nvar SaveApi = /** @class */ (function () {\\r\\n    function SaveApi() {\\r\\n        this.saveName = 'autoSave';\\r\\n        this.isAuto = true;\\r\\n        this.isDisabled = false;\\r\\n    }\\r\\n    SaveApi.prototype.enable = function () {\\r\\n        this.isDisabled = false;\\r\\n    };\\r\\n    SaveApi.prototype.disable = function (disable) {\\r\\n        if (disable === void 0) { disable = true; }\\r\\n        this.isDisabled = disable;\\r\\n    };\\r\\n    SaveApi.prototype.autoSave = function (enable) {\\r\\n        if (enable === void 0) { enable = true; }\\r\\n        this.isAuto = enable;\\r\\n        if (enable)\\r\\n            console.log('save api is enabled');\\r\\n        else\\r\\n            console.log('save api is disable');\\r\\n    };\\r\\n    SaveApi.prototype.saveSlot = function (saveName) {\\r\\n        this.saveName = saveName;\\r\\n    };\\r\\n    SaveApi.prototype.save = function (saveName) {\\r\\n        if (saveName === void 0) { saveName = this.saveName; }\\r\\n        if (this.dataGetter == null)\\r\\n            return;\\r\\n        if (this.isDisabled)\\r\\n            return;\\r\\n        var data = this.dataGetter();\\r\\n        localStorage.setItem(saveName, JSON.stringify(data));\\r\\n    };\\r\\n    SaveApi.prototype.load = function (saveName) {\\r\\n        if (saveName === void 0) { saveName = this.saveName; }\\r\\n        if (this.isDisabled)\\r\\n            return;\\r\\n        if (this.dataHandler == null)\\r\\n            return;\\r\\n        var state = JSON.parse(localStorage.getItem(saveName));\\r\\n        this.dataHandler(state);\\r\\n    };\\r\\n    SaveApi.prototype.loadFrom = function (obj) {\\r\\n        this.dataHandler(obj);\\r\\n    };\\r\\n    SaveApi.prototype.onPassage = function () {\\r\\n        if (this.isDisabled)\\r\\n            return;\\r\\n        if (this.isAuto) {\\r\\n            this.save(this.saveName);\\r\\n        }\\r\\n    };\\r\\n    return SaveApi;\\r\\n}());\\r\\nexports.SaveApi = SaveApi;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/runtime/saveapi/SaveApi.ts?\")},\"./wonder-format/ts/twine-game/AppState.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar AppState = /** @class */ (function () {\\r\\n    function AppState() {\\r\\n        this.history = {\\r\\n            pagesHash: {},\\r\\n            pages: []\\r\\n        };\\r\\n        this.runTime = {};\\r\\n    }\\r\\n    return AppState;\\r\\n}());\\r\\nexports.AppState = AppState;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/AppState.ts?')},\"./wonder-format/ts/twine-game/GameEvents.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar PageViewData = /** @class */ (function () {\\r\\n    function PageViewData(passage, state, config, viewChecker, pageCanGoBack) {\\r\\n        this.passage = passage;\\r\\n        this.state = state;\\r\\n        this.config = config;\\r\\n        this.viewChecker = viewChecker;\\r\\n        this.pageCanGoBack = pageCanGoBack;\\r\\n    }\\r\\n    return PageViewData;\\r\\n}());\\r\\nexports.PageViewData = PageViewData;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/GameEvents.ts?')},\"./wonder-format/ts/twine-game/GameLogic.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nvar __assign = (this && this.__assign) || function () {\\r\\n    __assign = Object.assign || function(t) {\\r\\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\\r\\n            s = arguments[i];\\r\\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\\r\\n                t[p] = s[p];\\r\\n        }\\r\\n        return t;\\r\\n    };\\r\\n    return __assign.apply(this, arguments);\\r\\n};\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar EventBus_1 = __webpack_require__(/*! ../app-core/EventBus */ \"./wonder-format/ts/app-core/EventBus.ts\");\\r\\nvar GameEvents_1 = __webpack_require__(/*! ./GameEvents */ \"./wonder-format/ts/twine-game/GameEvents.ts\");\\r\\nvar Constants_1 = __webpack_require__(/*! ../Constants */ \"./wonder-format/ts/Constants.ts\");\\r\\nvar GameConfig_1 = __webpack_require__(/*! ./logic/GameConfig */ \"./wonder-format/ts/twine-game/logic/GameConfig.ts\");\\r\\nvar WonderStoryParser_1 = __webpack_require__(/*! ./logic/WonderStoryParser */ \"./wonder-format/ts/twine-game/logic/WonderStoryParser.ts\");\\r\\nvar RunTime_1 = __webpack_require__(/*! ../runtime/RunTime */ \"./wonder-format/ts/runtime/RunTime.ts\");\\r\\nvar WonderHistory_1 = __webpack_require__(/*! ./logic/WonderHistory */ \"./wonder-format/ts/twine-game/logic/WonderHistory.ts\");\\r\\nvar AppState_1 = __webpack_require__(/*! ./AppState */ \"./wonder-format/ts/twine-game/AppState.ts\");\\r\\nvar Stores_1 = __webpack_require__(/*! ./Stores */ \"./wonder-format/ts/twine-game/Stores.ts\");\\r\\nvar GameLogic = /** @class */ (function () {\\r\\n    function GameLogic() {\\r\\n        var _this = this;\\r\\n        this.gameConfig = new GameConfig_1.GameConfig();\\r\\n        this.history = new WonderHistory_1.WonderHistory();\\r\\n        this.isStart = true;\\r\\n        this.isInitialStateLoaded = false;\\r\\n        this.runTime = new RunTime_1.RunTime();\\r\\n        // @ts-ignore\\r\\n        window.w = this.runTime;\\r\\n        // @ts-ignore\\r\\n        window.Wonder = window.w;\\r\\n        Stores_1.STORE.state = new AppState_1.AppState();\\r\\n        this.runTime.onStateLoad(function (state) { return _this.onStateLoad(state); });\\r\\n        EventBus_1.EventBus.getInstance()\\r\\n            .sub(\"onPassagePrepared\" /* onPassagePrepared */, function (message, data) { return _this.onPassagePrepared(data); })\\r\\n            .sub(\"onLinkClick\" /* onLinkClick */, function (message, id) { return _this.onClick(id); })\\r\\n            .sub(\"onBackClick\" /* onBackClick */, function (message) { return _this.onBackClick(); });\\r\\n    }\\r\\n    // не нужен ли тут прелоадер? )\\r\\n    GameLogic.prototype.loadStory = function (story) {\\r\\n        Stores_1.STORY_STORE.story = story;\\r\\n        var gameVars = {};\\r\\n        this.exeScript(story.script, gameVars);\\r\\n        console.log(\\'story.script\\', gameVars);\\r\\n        console.log(\\'loadStory, script executed...\\');\\r\\n        WonderStoryParser_1.WonderStoryParser.parse(story, gameVars, this.gameConfig);\\r\\n        // если было загружено состояние - восстанавливаем его\\r\\n        if (this.isInitialStateLoaded) {\\r\\n            this.setUtilStates(Stores_1.STORE.state);\\r\\n        }\\r\\n        else {\\r\\n            // иначе инициализируем исполненные начальные переменные\\r\\n            this.runTime.setGameVars(gameVars);\\r\\n        }\\r\\n        console.log(\\'loadStory 2, game parsed...\\');\\r\\n        EventBus_1.EventBus.emit(\"onStoryLoaded\" /* onStoryLoaded */, story);\\r\\n        this.runTime.onStoryReady();\\r\\n        this.isStart = false;\\r\\n        this.startGame(Stores_1.STORY_STORE.story, Stores_1.STORE.state);\\r\\n    };\\r\\n    /*********\\r\\n     * LOGIC\\r\\n     *********/\\r\\n    GameLogic.prototype.getStartPage = function (story, state) {\\r\\n        var hPages = state.history.pages;\\r\\n        var lastPage = hPages[hPages.length - 1];\\r\\n        return lastPage || story.startPassageName;\\r\\n    };\\r\\n    GameLogic.prototype.startGame = function (story, state) {\\r\\n        this.onClick(this.getStartPage(story, state));\\r\\n    };\\r\\n    GameLogic.prototype.prepareToShow = function (name) {\\r\\n        console.log(\\'prepareToShow\\', name);\\r\\n        EventBus_1.EventBus.emit(\"preparePassage\" /* preparePassage */, this.getViewPassage(name));\\r\\n    };\\r\\n    GameLogic.prototype.onPassagePrepared = function (passage) {\\r\\n        this.showPassage(passage);\\r\\n        var appState = Stores_1.STORE.state;\\r\\n        this.runTime.onPassage(passage, appState);\\r\\n        console.log(\\'onPassagePrepared\\', appState);\\r\\n    };\\r\\n    GameLogic.prototype.showPassage = function (passage) {\\r\\n        EventBus_1.EventBus.emit(\"showPassage\" /* showPassage */, passage);\\r\\n    };\\r\\n    GameLogic.prototype.onClick = function (name) {\\r\\n        console.log(\\'onClick\\', name);\\r\\n        this.prepareToShow(name);\\r\\n        this.history.add(name); // текущий узел идёт в историю\\r\\n        this.updateState();\\r\\n    };\\r\\n    GameLogic.prototype.onBackClick = function () {\\r\\n        this.history.pop(); // текущий узел уходит из истории\\r\\n        var name = this.history.getLast();\\r\\n        this.onClick(name);\\r\\n    };\\r\\n    /*********\\r\\n     * helpers\\r\\n     *********/\\r\\n    // выполнить скрипт, забинденный на game\\r\\n    GameLogic.prototype.exeScript = function (script, context) {\\r\\n        var result = null;\\r\\n        try {\\r\\n            var func = new Function(script).bind(context); // создаю функцию из строки\\r\\n            result = func(); // исполняю функцию\\r\\n        }\\r\\n        catch (e) {\\r\\n            // todo сделать вывод без консоли, оповещение\\r\\n            // м.б. запись в историю ошибок\\r\\n            // потому что сейчас весь консольный лог в продакшене чистится\\r\\n            console.warn(\\' Wonder - UserScript error:\\' + e);\\r\\n        }\\r\\n        return result;\\r\\n    };\\r\\n    /**\\r\\n     * Формирует viewPassage для отображения\\r\\n     * + исполняет логику\\r\\n     * @param name\\r\\n     */\\r\\n    GameLogic.prototype.getViewPassage = function (name) {\\r\\n        var viewPassage = __assign({}, Stores_1.STORY_STORE.story.passageHash[name]);\\r\\n        console.log(\\'getViewPassage\\', name, viewPassage);\\r\\n        this.execScripts(viewPassage);\\r\\n        return new GameEvents_1.PageViewData(viewPassage, this.runTime.getGameVars(), this.gameConfig, this.history, this.history);\\r\\n    };\\r\\n    /**\\r\\n     * Исполнить скрипты и вывести их результат, если нужно\\r\\n     * @param viewPassage\\r\\n     */\\r\\n    GameLogic.prototype.execScripts = function (viewPassage) {\\r\\n        var _this = this;\\r\\n        console.log(\"execScripts........\");\\r\\n        console.log(\"viewPassage.content\", viewPassage.content);\\r\\n        var context = this.runTime.getGameVars();\\r\\n        // ищем строки, которые должны исполняться\\r\\n        viewPassage.content = viewPassage.content\\r\\n            .replace(Constants_1.REGEXP.exeScript, function (match, catched) {\\r\\n            var command = catched.trim();\\r\\n            var isInline = command[0] == Constants_1.WONDER.inlineStart;\\r\\n            if (isInline)\\r\\n                command = \"return \" + command.substring(1);\\r\\n            var result = _this.exeScript(command, context);\\r\\n            var render = isInline ? result : \"\";\\r\\n            return render;\\r\\n        });\\r\\n        console.log(\"....... /execScripts\");\\r\\n    };\\r\\n    /********************\\r\\n     *  STATE MANAGEMENT\\r\\n     *******************/\\r\\n    GameLogic.prototype.updateState = function () {\\r\\n        var appState = Stores_1.STORE.state;\\r\\n        appState.history = this.history.getState();\\r\\n        appState.runTime = this.runTime.getState();\\r\\n        return appState;\\r\\n    };\\r\\n    GameLogic.prototype.onStateLoad = function (state) {\\r\\n        console.log(\\'onStateLoad\\', state);\\r\\n        if (state == null)\\r\\n            return;\\r\\n        Stores_1.STORE.state = __assign(__assign({}, Stores_1.STORE.state), state);\\r\\n        var appState = Stores_1.STORE.state;\\r\\n        console.log(\\'this.appState\\', appState);\\r\\n        if (this.isInitialStateLoaded == false) {\\r\\n            this.isInitialStateLoaded = true;\\r\\n        }\\r\\n        if (this.isStart)\\r\\n            return;\\r\\n        this.setUtilStates(appState);\\r\\n        this.startGame(Stores_1.STORY_STORE.story, Stores_1.STORE.state);\\r\\n    };\\r\\n    GameLogic.prototype.setUtilStates = function (appState) {\\r\\n        this.history.setState(appState.history);\\r\\n        this.runTime.setState(appState.runTime);\\r\\n    };\\r\\n    return GameLogic;\\r\\n}());\\r\\nexports.GameLogic = GameLogic;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/GameLogic.ts?')},\"./wonder-format/ts/twine-game/GameView.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar EventBus_1 = __webpack_require__(/*! ../app-core/EventBus */ \"./wonder-format/ts/app-core/EventBus.ts\");\\r\\nvar Constants_1 = __webpack_require__(/*! ../Constants */ \"./wonder-format/ts/Constants.ts\");\\r\\nvar WonderPageView_1 = __webpack_require__(/*! ./view/WonderPageView */ \"./wonder-format/ts/twine-game/view/WonderPageView.ts\");\\r\\nvar DomUtils_1 = __webpack_require__(/*! ../app-core/DomUtils */ \"./wonder-format/ts/app-core/DomUtils.ts\");\\r\\nvar Stores_1 = __webpack_require__(/*! ./Stores */ \"./wonder-format/ts/twine-game/Stores.ts\");\\r\\nvar GameView = /** @class */ (function () {\\r\\n    function GameView() {\\r\\n        var _this = this;\\r\\n        this.el = document.createElement(\"div\");\\r\\n        this.el.id = Constants_1.WONDER.contentId;\\r\\n        document.body.appendChild(this.el);\\r\\n        this.el.addEventListener(\"click\", this);\\r\\n        this.pageView = new WonderPageView_1.WonderPageView(this.el);\\r\\n        EventBus_1.EventBus.getInstance()\\r\\n            .sub(\"onStoryLoaded\" /* onStoryLoaded */, function (message, data) { return _this.onStoryLoaded(data); })\\r\\n            .sub(\"preparePassage\" /* preparePassage */, function (message, data) { return _this.preparePassage(data); })\\r\\n            .sub(\"showPassage\" /* showPassage */, function (message, data) { return _this.showPassage(data); });\\r\\n    }\\r\\n    GameView.prototype.handleEvent = function (e) {\\r\\n        if (this.checkLinkClick(e))\\r\\n            return;\\r\\n        if (this.checkBackClick(e))\\r\\n            return;\\r\\n    };\\r\\n    GameView.prototype.checkClick = function (e, selector, callback) {\\r\\n        var linkElement = DomUtils_1.DomUtils.closest(e.target, selector);\\r\\n        if (linkElement)\\r\\n            callback(linkElement, e);\\r\\n        return linkElement != null;\\r\\n    };\\r\\n    GameView.prototype.checkLinkClick = function (e) {\\r\\n        return this.checkClick(e, \".\" + Constants_1.WONDER.linkClass, function (el, e1) {\\r\\n            var id = el.dataset[\"id\"];\\r\\n            EventBus_1.EventBus.emit(\"onLinkClick\" /* onLinkClick */, id);\\r\\n        });\\r\\n    };\\r\\n    GameView.prototype.checkBackClick = function (e) {\\r\\n        return this.checkClick(e, \".\" + Constants_1.WONDER.backClass, function (el, e1) {\\r\\n            EventBus_1.EventBus.emit(\"onBackClick\" /* onBackClick */, null);\\r\\n        });\\r\\n    };\\r\\n    GameView.prototype.injectStyle = function (style) {\\r\\n        if (style.length == 0)\\r\\n            return;\\r\\n        var styleElement = document.createElement(\\'style\\');\\r\\n        styleElement.innerHTML = style;\\r\\n        document.getElementsByTagName(\\'head\\')[0].appendChild(styleElement);\\r\\n    };\\r\\n    /**********************\\r\\n     *   events\\r\\n     *********************/\\r\\n    GameView.prototype.onStoryLoaded = function (story) {\\r\\n        console.log(\"onStoryLoaded\", story);\\r\\n    };\\r\\n    GameView.prototype.preparePassage = function (pageViewData) {\\r\\n        var passage = pageViewData.passage;\\r\\n        console.log(\"preparePassage\", passage);\\r\\n        var page = this.pageView.addNextPage(passage);\\r\\n        this.setPageNameAsBodyId(pageViewData);\\r\\n        this.markVisitedLinks(page, pageViewData.viewChecker);\\r\\n        this.showBackLink(page, pageViewData.pageCanGoBack, passage);\\r\\n        // страница добавлена, но еще не видима, можно менять DOM\\r\\n        this.injectParams(page, pageViewData.config.uiParams, pageViewData.state);\\r\\n        EventBus_1.EventBus.emit(\"onPassagePrepared\" /* onPassagePrepared */, passage);\\r\\n    };\\r\\n    GameView.prototype.setPageNameAsBodyId = function (pageViewData) {\\r\\n        document.body.id = pageViewData.passage.name;\\r\\n        document.body.className = pageViewData.passage.tags;\\r\\n    };\\r\\n    GameView.prototype.showPassage = function (passage) {\\r\\n        console.log(\"showPassage\", passage);\\r\\n        this.pageView.showNextPage();\\r\\n    };\\r\\n    GameView.prototype.injectParams = function (page, uiParams, state) {\\r\\n        uiParams.forEach(function (uP) {\\r\\n            console.log(\"uP\", uP);\\r\\n            var paramName = uP.name;\\r\\n            var paramValue = state[uP.name];\\r\\n            var el = page.querySelector(uP.name);\\r\\n            if (el) {\\r\\n                el.innerHTML = paramName + \":\" + paramValue;\\r\\n            }\\r\\n        });\\r\\n    };\\r\\n    GameView.prototype.markVisitedLinks = function (page, viewChecker) {\\r\\n        var links = page.querySelectorAll(\".\" + Constants_1.WONDER.linkClass);\\r\\n        var passageMap = Stores_1.STORY_STORE.story.passageHash;\\r\\n        var next, nextLinkName;\\r\\n        for (var i = 0; i < links.length; i++) {\\r\\n            next = links[i];\\r\\n            nextLinkName = next.dataset[\"id\"];\\r\\n            if (viewChecker.isViewed(nextLinkName)) {\\r\\n                next.classList.add(Constants_1.WONDER.visitedClass);\\r\\n            }\\r\\n            // теги пассажей\\r\\n            var linkPassage = passageMap[nextLinkName];\\r\\n            if (linkPassage && linkPassage.tags) {\\r\\n                next.className = next.className + \\' \\' + linkPassage.tags;\\r\\n            }\\r\\n        }\\r\\n    };\\r\\n    GameView.prototype.showBackLink = function (page, canGoBack, passage) {\\r\\n        var backButton = page.querySelector(\".\" + Constants_1.WONDER.backClass);\\r\\n        if (backButton == null)\\r\\n            return;\\r\\n        var canShowBackButton = canGoBack.canGoBack(passage.name);\\r\\n        if (canShowBackButton)\\r\\n            backButton.classList.remove(Constants_1.WONDER.invisibleClass);\\r\\n        else\\r\\n            backButton.classList.add(Constants_1.WONDER.invisibleClass);\\r\\n    };\\r\\n    return GameView;\\r\\n}());\\r\\nexports.GameView = GameView;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/GameView.ts?')},\"./wonder-format/ts/twine-game/Stores.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar StoryStore = /** @class */ (function () {\\r\\n    function StoryStore() {\\r\\n    }\\r\\n    return StoryStore;\\r\\n}());\\r\\nexports.STORY_STORE = new StoryStore();\\r\\nvar AppStore = /** @class */ (function () {\\r\\n    function AppStore() {\\r\\n    }\\r\\n    return AppStore;\\r\\n}());\\r\\nexports.STORE = new AppStore();\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/Stores.ts?')},\"./wonder-format/ts/twine-game/logic/GameConfig.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar GameState = /** @class */ (function () {\\r\\n    function GameState() {\\r\\n    }\\r\\n    return GameState;\\r\\n}());\\r\\nexports.GameState = GameState;\\r\\nvar GameConfig = /** @class */ (function () {\\r\\n    function GameConfig() {\\r\\n        this.uiParams = [];\\r\\n    }\\r\\n    return GameConfig;\\r\\n}());\\r\\nexports.GameConfig = GameConfig;\\r\\nvar VisibleParameter = /** @class */ (function () {\\r\\n    function VisibleParameter(name, // имя переменной - оно же id переменной\\r\\n    label // что видит пользовател\\r\\n    ) {\\r\\n        this.name = name;\\r\\n        this.label = label;\\r\\n    }\\r\\n    return VisibleParameter;\\r\\n}());\\r\\nexports.VisibleParameter = VisibleParameter;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/logic/GameConfig.ts?')},\"./wonder-format/ts/twine-game/logic/WonderHistory.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar WonderHistory = /** @class */ (function () {\\r\\n    function WonderHistory() {\\r\\n        this.clear();\\r\\n    }\\r\\n    WonderHistory.prototype.getState = function () {\\r\\n        return {\\r\\n            pages: this.pages,\\r\\n            pagesHash: this.pagesHash\\r\\n        };\\r\\n    };\\r\\n    WonderHistory.prototype.setState = function (state) {\\r\\n        if (state == null)\\r\\n            return;\\r\\n        this.pages = state.pages;\\r\\n        this.pagesHash = state.pagesHash;\\r\\n    };\\r\\n    WonderHistory.prototype.clear = function () {\\r\\n        this.pages = [];\\r\\n        this.pagesHash = {};\\r\\n    };\\r\\n    WonderHistory.prototype.add = function (name) {\\r\\n        if (name == null)\\r\\n            return;\\r\\n        if (this.getLast() == name)\\r\\n            return; // защита от повторов\\r\\n        this.pages.push(name);\\r\\n        this.pagesHash[name] = true;\\r\\n    };\\r\\n    WonderHistory.prototype.isViewed = function (name) {\\r\\n        return this.pagesHash[name] == true;\\r\\n    };\\r\\n    WonderHistory.prototype.pop = function () {\\r\\n        return this.pages.pop();\\r\\n    };\\r\\n    WonderHistory.prototype.canGoBack = function (name) {\\r\\n        var hasHistory = this.pages.length > 0;\\r\\n        if (!hasHistory)\\r\\n            return false;\\r\\n        var hasSinglePage = this.pages.length == 1;\\r\\n        var hasSameFirstPage = this.pages[0] && this.pages[0] == name;\\r\\n        return !(hasSinglePage && hasSameFirstPage);\\r\\n    };\\r\\n    WonderHistory.prototype.getLast = function () {\\r\\n        return this.pages[this.pages.length - 1];\\r\\n    };\\r\\n    return WonderHistory;\\r\\n}());\\r\\nexports.WonderHistory = WonderHistory;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/logic/WonderHistory.ts?')},\"./wonder-format/ts/twine-game/logic/WonderStoryParser.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\n/**\\r\\n *  Парсинг расширенных команд формата Wonder\\r\\n */\\r\\nvar GameConfig_1 = __webpack_require__(/*! ./GameConfig */ \"./wonder-format/ts/twine-game/logic/GameConfig.ts\");\\r\\nvar Constants_1 = __webpack_require__(/*! ../../Constants */ \"./wonder-format/ts/Constants.ts\");\\r\\nvar WonderStoryParser = /** @class */ (function () {\\r\\n    function WonderStoryParser() {\\r\\n    }\\r\\n    WonderStoryParser.parse = function (story, state, config) {\\r\\n        parseConfig(story.passageHash[Constants_1.WONDER.passages.config], state, config);\\r\\n    };\\r\\n    return WonderStoryParser;\\r\\n}());\\r\\nexports.WonderStoryParser = WonderStoryParser;\\r\\nfunction parseConfig(passage, state, config) {\\r\\n    if (passage == null)\\r\\n        return;\\r\\n    var lines = splitLines(passage.content);\\r\\n    console.log(\"parseConfig \");\\r\\n    lines.forEach(function (str) {\\r\\n        str = str.trim();\\r\\n        if (str.length == 0)\\r\\n            return;\\r\\n        console.log(\"str = \", str);\\r\\n        parseVar(str, state, config);\\r\\n    });\\r\\n}\\r\\nfunction parseVar(str, state, config) {\\r\\n    if (beginsWith(str, Constants_1.WONDER.markLang.varStart) == false)\\r\\n        return;\\r\\n    console.log(\"has var\", str);\\r\\n    // начинается с varStart - пилим\\r\\n    var parts = str.split(Constants_1.WONDER.markLang.commandSplitter);\\r\\n    console.log(\"parts\", parts);\\r\\n    var varName = parts[1].trim();\\r\\n    var varValue = parts[2] || \"0\";\\r\\n    var varLabel = parts[3];\\r\\n    state[varName] = parseFloat(varValue);\\r\\n    console.log(\"varLabel \", varLabel);\\r\\n    console.log(\"parts \", parts);\\r\\n    if (varLabel) {\\r\\n        config.uiParams.push(new GameConfig_1.VisibleParameter(varName, varLabel));\\r\\n    }\\r\\n}\\r\\nfunction splitLines(str) {\\r\\n    return str.split(\"\\\\n\");\\r\\n}\\r\\nfunction beginsWith(str, begin) {\\r\\n    return str.indexOf(begin) == 0;\\r\\n}\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/logic/WonderStoryParser.ts?')},\"./wonder-format/ts/twine-game/view/PageAnimator.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar Constants_1 = __webpack_require__(/*! ../../Constants */ \"./wonder-format/ts/Constants.ts\");\\r\\nvar PageAnimator = /** @class */ (function () {\\r\\n    function PageAnimator() {\\r\\n    }\\r\\n    PageAnimator.prototype.show = function (el, duration) {\\r\\n        if (duration === void 0) { duration = 0; }\\r\\n        console.log(\"show el\", el);\\r\\n        el.classList.remove(Constants_1.COMMON_CSS.displayNone);\\r\\n    };\\r\\n    PageAnimator.prototype.hide = function (el, duration) {\\r\\n        if (duration === void 0) { duration = 0; }\\r\\n        console.log(\"hide el\", el);\\r\\n        el.classList.add(Constants_1.COMMON_CSS.displayNone);\\r\\n    };\\r\\n    return PageAnimator;\\r\\n}());\\r\\nexports.PageAnimator = PageAnimator;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/view/PageAnimator.ts?')},\"./wonder-format/ts/twine-game/view/PagePairView.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nvar __extends = (this && this.__extends) || (function () {\\r\\n    var extendStatics = function (d, b) {\\r\\n        extendStatics = Object.setPrototypeOf ||\\r\\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\\r\\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\\r\\n        return extendStatics(d, b);\\r\\n    };\\r\\n    return function (d, b) {\\r\\n        extendStatics(d, b);\\r\\n        function __() { this.constructor = d; }\\r\\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\\r\\n    };\\r\\n})();\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar PageView_1 = __webpack_require__(/*! ./PageView */ \"./wonder-format/ts/twine-game/view/PageView.ts\");\\r\\n/**\\r\\n *  Очередь страниц с ограниченной емкостью\\r\\n *  при добавлении страницы - первая выбрасывается\\r\\n */\\r\\nvar PagePairView = /** @class */ (function (_super) {\\r\\n    __extends(PagePairView, _super);\\r\\n    function PagePairView() {\\r\\n        var _this = _super !== null && _super.apply(this, arguments) || this;\\r\\n        _this.limit = 2;\\r\\n        return _this;\\r\\n    }\\r\\n    PagePairView.prototype.addPage = function (el) {\\r\\n        _super.prototype.addPage.call(this, el);\\r\\n        if (this.pages.length > this.limit) {\\r\\n            this.currentPage--; // так как массив сдвигается в начало\\r\\n            this.dropPage(0);\\r\\n        }\\r\\n    };\\r\\n    return PagePairView;\\r\\n}(PageView_1.PageView));\\r\\nexports.PagePairView = PagePairView;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/view/PagePairView.ts?')},\"./wonder-format/ts/twine-game/view/PageView.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\n/**\\r\\n *  Содержит несколько страниц, может их менять\\r\\n */\\r\\nvar PageAnimator_1 = __webpack_require__(/*! ./PageAnimator */ \"./wonder-format/ts/twine-game/view/PageAnimator.ts\");\\r\\nvar ArrayUtils_1 = __webpack_require__(/*! ../../app-core/ArrayUtils */ \"./wonder-format/ts/app-core/ArrayUtils.ts\");\\r\\nvar DomUtils_1 = __webpack_require__(/*! ../../app-core/DomUtils */ \"./wonder-format/ts/app-core/DomUtils.ts\");\\r\\nvar PageView = /** @class */ (function () {\\r\\n    function PageView() {\\r\\n        this.pages = [];\\r\\n        this.currentPage = -1;\\r\\n        this.animator = new PageAnimator_1.PageAnimator();\\r\\n    }\\r\\n    PageView.prototype.setAnimator = function (animator) {\\r\\n        this.animator = animator;\\r\\n    };\\r\\n    PageView.prototype.addPage = function (el) {\\r\\n        this.pages.push(el);\\r\\n    };\\r\\n    /**\\r\\n     * Показать следующую страницу\\r\\n     */\\r\\n    PageView.prototype.next = function () {\\r\\n        var PREV = this.getCurrent();\\r\\n        this.currentPage++;\\r\\n        this.setCurrent(this.currentPage);\\r\\n        var NEXT = this.getCurrent();\\r\\n        this.switch(PREV, NEXT);\\r\\n    };\\r\\n    /**\\r\\n     *  Показать предыдущую страницы\\r\\n     */\\r\\n    PageView.prototype.previous = function () {\\r\\n        var PREV = this.getCurrent();\\r\\n        this.currentPage--;\\r\\n        this.setCurrent(this.currentPage);\\r\\n        var NEXT = this.getCurrent();\\r\\n        this.switch(PREV, NEXT);\\r\\n    };\\r\\n    /*********\\r\\n     *  PRIVATE\\r\\n     ********/\\r\\n    PageView.prototype.switch = function (from, to) {\\r\\n        if (from)\\r\\n            this.animator.hide(from);\\r\\n        this.animator.show(to);\\r\\n    };\\r\\n    PageView.prototype.getCurrent = function () {\\r\\n        return this.pages[this.currentPage];\\r\\n    };\\r\\n    /**\\r\\n     * Циклически идет по кругу,\\r\\n     * переключает на конец или начало, если выходит за рамки\\r\\n     * @param n\\r\\n     */\\r\\n    PageView.prototype.setCurrent = function (n) {\\r\\n        if (this.pages.length == 0) {\\r\\n            throw \"setCurrent error - void pages\";\\r\\n        }\\r\\n        var max = this.pages.length - 1;\\r\\n        if (n > max)\\r\\n            n = 0;\\r\\n        else if (n < 0)\\r\\n            n = max;\\r\\n        this.currentPage = n;\\r\\n    };\\r\\n    PageView.prototype.dropPage = function (index) {\\r\\n        var removed = ArrayUtils_1.ArrayUtils.remove(this.pages, index);\\r\\n        if (removed == null) {\\r\\n            console.warn(\"dropPage: try to remove undefined page\");\\r\\n            return;\\r\\n        }\\r\\n        DomUtils_1.DomUtils.remove(removed);\\r\\n    };\\r\\n    return PageView;\\r\\n}());\\r\\nexports.PageView = PageView;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/view/PageView.ts?')},\"./wonder-format/ts/twine-game/view/ViewBuilder.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar DomUtils_1 = __webpack_require__(/*! ../../app-core/DomUtils */ \"./wonder-format/ts/app-core/DomUtils.ts\");\\r\\n/**\\r\\n *  Универсальный форматтер\\r\\n *  - устанавливает выбранный шаблон\\r\\n */\\r\\nvar ViewBuilder = /** @class */ (function () {\\r\\n    function ViewBuilder(template) {\\r\\n        this.template = template;\\r\\n        this.contentFormatter = function (str, template) { return template; };\\r\\n    }\\r\\n    ViewBuilder.prototype.setTemplate = function (template) {\\r\\n        this.template = template;\\r\\n    };\\r\\n    ViewBuilder.prototype.setContentFormatter = function (formatter) {\\r\\n        this.contentFormatter = formatter;\\r\\n    };\\r\\n    ViewBuilder.prototype.build = function (content) {\\r\\n        if (content === void 0) { content = \"\"; }\\r\\n        var formatted = this.contentFormatter(content, this.template);\\r\\n        var pageEl = DomUtils_1.DomUtils.elementFromTemplate(formatted);\\r\\n        return pageEl;\\r\\n    };\\r\\n    return ViewBuilder;\\r\\n}());\\r\\nexports.ViewBuilder = ViewBuilder;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/view/ViewBuilder.ts?')},\"./wonder-format/ts/twine-game/view/WonderPageView.ts\":function(module,exports,__webpack_require__){\"use strict\";eval('\\r\\nObject.defineProperty(exports, \"__esModule\", { value: true });\\r\\nvar PagePairView_1 = __webpack_require__(/*! ./PagePairView */ \"./wonder-format/ts/twine-game/view/PagePairView.ts\");\\r\\nvar EventBus_1 = __webpack_require__(/*! ../../app-core/EventBus */ \"./wonder-format/ts/app-core/EventBus.ts\");\\r\\nvar ViewBuilder_1 = __webpack_require__(/*! ./ViewBuilder */ \"./wonder-format/ts/twine-game/view/ViewBuilder.ts\");\\r\\nvar Constants_1 = __webpack_require__(/*! ../../Constants */ \"./wonder-format/ts/Constants.ts\");\\r\\nvar FormatTwinePassageAsHTML_1 = __webpack_require__(/*! ../../parser/FormatTwinePassageAsHTML */ \"./wonder-format/ts/parser/FormatTwinePassageAsHTML.ts\");\\r\\nvar WonderPageView = /** @class */ (function () {\\r\\n    function WonderPageView(parent) {\\r\\n        var _this = this;\\r\\n        this.parent = parent;\\r\\n        this.pageView = new PagePairView_1.PagePairView();\\r\\n        this.pageBuilder = new ViewBuilder_1.ViewBuilder(Constants_1.PAGE_TEMPLATE);\\r\\n        this.contentBuilder = new ViewBuilder_1.ViewBuilder(Constants_1.PASSAGE_TEMPLATE);\\r\\n        this.contentBuilder.setContentFormatter(FormatTwinePassageAsHTML_1.formatTwinePassageAsHTML);\\r\\n        EventBus_1.EventBus.getInstance()\\r\\n            .sub(\"onPageFormatLoaded\" /* onPageFormatLoaded */, function (message, format) { return _this.pageBuilder.setTemplate(format); })\\r\\n            .sub(\"onPassageFormatLoaded\" /* onContentFormatLoaded */, function (message, format) { return _this.contentBuilder.setTemplate(format); });\\r\\n    }\\r\\n    WonderPageView.prototype.addNextPage = function (passage) {\\r\\n        var page = this.buildPageView(passage);\\r\\n        this.pageView.addPage(page);\\r\\n        return page;\\r\\n    };\\r\\n    WonderPageView.prototype.showNextPage = function () {\\r\\n        this.pageView.next();\\r\\n    };\\r\\n    /**********************\\r\\n     *   show page\\r\\n     *********************/\\r\\n    WonderPageView.prototype.buildPageView = function (passage) {\\r\\n        var SOURCE = passage.content;\\r\\n        var passageView = this.contentBuilder.build(SOURCE);\\r\\n        var pageView = this.pageBuilder.build();\\r\\n        pageView.classList.add(Constants_1.COMMON_CSS.displayNone);\\r\\n        pageView.appendChild(passageView);\\r\\n        this.parent.appendChild(pageView);\\r\\n        return pageView;\\r\\n    };\\r\\n    return WonderPageView;\\r\\n}());\\r\\nexports.WonderPageView = WonderPageView;\\r\\n\\n\\n//# sourceURL=webpack:///./wonder-format/ts/twine-game/view/WonderPageView.ts?')}});"+ '</script>' +
    '        </body>\n' +
    '    </html>';


window.storyFormat({
    name: 'twine-wonder',
    version: '0.6.16',
    author: 'Kvisaz [Sergey Tokarev]',
    description: 'Twine Wonder Format',
    proofing: false,
    url: 'https://github.com/Kvisaz/twine-wonder',
    image: 'icon.svg',
    source: SOURCE,
});
