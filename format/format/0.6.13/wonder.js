var SOURCE = '<!DOCTYPE html>\n' +
    '    <html>\n' +
    '        <head>\n' +
    '            <meta name="viewport" content="width=device-width, initial-scale=1">\n' +
    '            <meta charset="utf-8">\n' +
    '            <title>{{STORY_NAME}}</title>\n' +
    '            <style></style>\n' +
    '        </head>\n' +
    '        <body>\n' +
    '            <tw-story tags></tw-story>\n' +
    '            {{STORY_DATA}}\n' +
    '            <script>' + "!function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(t,\"__esModule\",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&\"object\"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,\"default\",{enumerable:!0,value:t}),2&e&&\"string\"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,\"a\",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p=\"\",n(n.s=7)}([function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0}),e.STORY_SELECTOR=\"tw-storydata\",e.PASSAGE_SELECTOR=\"tw-passagedata\",e.COMMON_CSS={displayNone:\"displayNone\",pointerOver:\"pointerOver\",visited:\"visited\",back:\"back\"},e.WONDER={contentId:\"wonder-content\",pageClass:\"page\",pageContentClass:\"page-content\",textClass:\"text\",choiceClass:\"choice\",linkClass:\"link\",linkAloneClass:\"link-alone\",newLineClass:\"newLine\",linkInlineClass:\"inline\",noSelectClass:\"noselect\",selectClass:\"select\",paramClass:\"params\",visitedClass:e.COMMON_CSS.visited,backClass:e.COMMON_CSS.back,invisibleClass:e.COMMON_CSS.displayNone,template:{text:\"<text/>\",choices:\"<choices/>\",choiceStart:\"<choice>\",choiceEnd:\"</choice>\",choiceText:\"<choice-text/>\",choiceId:\"<choice-id/>\"},passages:{config:\"wonder.config\",pageFormat:\"wonder.format.page\",choiceFormat:\"wonder.format.choice\",textFormat:\"wonder.format.text\"},markLang:{varStart:\"var\",commandSplitter:\":\"},inlineStart:\"=\"};e.REGEXP={exeScript:new RegExp(\"{{([\\\\s\\\\S]*?)}}\",\"g\"),twineLink:new RegExp(\"\\\\[\\\\[([\\\\s\\\\S]*?)\\\\]\\\\]\",\"g\")},e.PAGE_TEMPLATE='<div class=\"'+e.WONDER.noSelectClass+\" \"+e.WONDER.pageClass+'\"></div>',e.LINK_TEMPLATE='<span class=\"'+e.WONDER.linkClass+\"  \"+e.WONDER.linkAloneClass+'\" data-id=\"'+e.WONDER.template.choiceId+'\">'+e.WONDER.template.choiceText+\"</span>\",e.LINK_INLINE_TEMPLATE='<span class=\"'+e.WONDER.linkClass+'\" data-id=\"'+e.WONDER.template.choiceId+'\">'+e.WONDER.template.choiceText+\"</span>\",e.BACK_TEMPLATE='<div class=\"'+e.WONDER.backClass+'\">Назад</div>',e.PASSAGE_TEMPLATE='<div class=\"'+e.WONDER.pageContentClass+'\">\\n'+e.BACK_TEMPLATE+'\\n<div class=\"'+e.WONDER.paramClass+'\" ><div id=\"gold\"></div></div>\\n<div class=\"'+e.WONDER.textClass+'\"><text/></div>\\n</div>',e.DEFAULT_STYLE='\\n     * {user-select: none;}\\n    .noselect { user-select: none; }    \\n    .select {  user-select: text; }\\n    .page .displayNone, .displayNone {\\n        display: none; \\n    }\\n    html, body{height: 100%}\\n    .pointerOver {\\n        cursor: pointer;\\n    }\\n    \\n    ul, li {\\n        margin: 0;\\n        padding: 0;\\n        list-style: none;\\n    }\\n    \\n    body {\\n        margin: 0;\\n        padding: 0;\\n        background: #ceceb7;\\n        font-family: \"Verdana\", \"Roboto\", \"Open Sans\", sans-serif;\\n        position: relative;\\n        display: flex;\\n        justify-content: center;\\n        align-items: start;\\n    }\\n    \\n    .'+e.WONDER.newLineClass+\" {\\n        display: block;\\n    }\\n    \\n    #\"+e.WONDER.contentId+\" {\\n        width: 800px;\\n        border-radius: 0 0 8px 8px;\\n        overflow: hidden;\\n    }\\n    \\n    .\"+e.WONDER.pageClass+\" {\\n          background: beige;          \\n     }\\n     \\n     .\"+e.WONDER.pageContentClass+\" {\\n          display: flex;\\n          flex-direction: column;\\n          padding: 12px;\\n     }\\n        \\n    .\"+e.WONDER.paramClass+\"{\\n        margin-bottom: 12px;\\n    }\\n        \\n        \\n    .\"+e.WONDER.textClass+\" {\\n        margin: 0;\\n        font-size: 18px;\\n        line-height: 26px;\\n    }\\n    \\n    .\"+e.WONDER.linkClass+\"{\\n        display: block;\\n        cursor: pointer;\\n        padding: 5px 35px;\\n        border-radius: 5px;\\n        background: #d5c695;\\n    }\\n        \\n    .\"+e.WONDER.linkClass+\":hover, .\"+e.WONDER.backClass+\":hover{\\n        color: #4b0d1e;\\n        background: #d5b562;       \\n    }\\n    \\n    .\"+e.WONDER.visitedClass+\":after {\\n        content: '  (прочитано)';\\n        font-size: smaller;\\n     }\\n     \\n     .\"+e.WONDER.visitedClass+\" {\\n        opacity: 0.65;\\n        font-size: smaller;\\n     }\\n    \\n    .\"+e.WONDER.backClass+\" {\\n        cursor: pointer;\\n        display: inline-block;\\n        margin-left: 0;\\n        margin-right: auto;\\n        margin-bottom: 4px;\\n        padding: 4px;\\n        border-radius: 5px;\\n        background: #eae2c5;\\n        color: #6c6c6c;\\n    }\\n    \\n     .\"+e.WONDER.backClass+\":before {\\n        content: '<';\\n     }\\n   \\n    \\n    .\"+e.WONDER.linkAloneClass+\"{\\n        margin-top: 0px;\\n    }\\n    \\n    .\"+e.WONDER.linkAloneClass+\":hover{\\n        margin-top: -2px;\\n        margin-bottom: 2px;\\n        box-shadow: 2px 2px 1px #414141;\\n    }\\n    \\n    #c-wrapper{\\n        position: absolute;\\n        display: flex;\\n        flex-direction: column;\\n        top: 0;\\n        left: 0;\\n    }\\n    \\n    .c-button{\\n        width: 96px;     \\n        line-height: 1em;\\n        background: antiquewhite;\\n        margin-top: 24px;\\n        text-align: center;\\n        cursor: pointer;\\n        box-shadow: 1px 2px 6px black;\\n    }\\n    \\n    .c-button:hover {\\n        transform: scale(1.09) translateX(4px);\\n        box-shadow: 1px 2px 6px black;\\n    }\\n    \\n    .c-bt-title{\\n        font-size: 16px;\\n        text-align: center;\\n        height: 1em;\\n        line-height: 1em;\\n        background: #b66e13;\\n        margin-bottom: 12px;\\n        padding: 2px;\\n    }\\n    \\n    .c-bt-content{\\n        font-size: 24px;\\n        text-align: center;\\n        height: 1em;\\n        line-height: 1em;\\n        margin-bottom: 12px;\\n    }\\n    \\n    .c-list{\\n        position: absolute;\\n        height: 89%;\\n        width: 800px;        \\n        top: 10%;\\n        left: 0;\\n        transform: translate(-100%, 0);\\n        background: #876b38;\\n        transition-duration: 0.45s;\\n        animation-timing-function: ease-out;\\n        box-shadow: 1px 2px 6px rgba(0,0,0,0.65);\\n    }\\n    \\n    .c-list-show{\\n        left: 50%;\\n        transform: translate(-49%, 0);\\n    }\\n    \\n    .c-list-title{\\n        font-size: 32px;    \\n         color: antiquewhite;   \\n        margin: 12px;\\n     }\\n        \\n    .c-list-content{\\n        font-size: 24px;\\n        overflow: auto;\\n        padding: 12px;\\n        background: #d7d7c5;\\n        border: 1px solid #afafaf;\\n        height: 90%;\\n    }\\n    .c-item{ \\n         padding: 12px;\\n         border: 1px solid #afafaf;\\n         cursor: pointer;\\n         background: beige;\\n         border-radius: 4px;\\n         margin-top: 6px;\\n    }\\n    \\n    .c-item:hover {\\n        transform: scale(1.01);\\n        background: #fffffc;\\n        box-shadow: 1px 2px 6px rgba(0,0,0,0.65);\\n    }   \\n    \\n    .c-list-content::-webkit-scrollbar { width: 32px; }\\n        \\n    .c-list-content::-webkit-scrollbar-track {\\n        background: #d0ac75;\\n        border-radius: 16px;    \\n    }\\n    .c-list-content::-webkit-scrollbar-thumb {\\n          background-color: #f1760c;   \\n          border-radius: 20px;       \\n          border: 2px solid #6f3909; \\n    }\\n    \\n    .c-page{\\n        position: absolute;\\n        height: 95%;\\n        width: 800px;        \\n        top: 3%;\\n        left: 0;\\n        transform: translate(-100%, 0);        \\n        background: beige;\\n        overflow: auto;\\n        transition-duration: 0.45s;\\n        animation-timing-function: ease-out;\\n        box-shadow: 1px 2px 6px rgba(0,0,0,0.65);\\n    }\\n    \\n    .c-page-content{\\n        margin: 12px 12px 16px;\\n    }\\n    \\n    .c-page-show{\\n        left: 50%;\\n        transform: translate(-47%, 0);\\n    }\\n    \\n    .c-page::-webkit-scrollbar { width: 32px; }\\n        \\n    .c-page::-webkit-scrollbar-track {\\n        background: #d0ac75;\\n        border-radius: 16px;    \\n    }\\n    .c-page::-webkit-scrollbar-thumb {\\n          background-color: #ce9643;   \\n          border-radius: 20px;       \\n          border: 2px solid #efd0a6; \\n    }\\n    \\n    @media screen and (max-width: 800px){\\n        .\"+e.WONDER.contentId+\" {\\n             width: 100%;\\n             margin: 0;\\n             border-radius: 0;\\n        }\\n    }\\n\"},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=function(){function t(){}return t.divWith=function(t){var e=document.createElement(\"div\");return e.innerHTML=t,e},t.elementFromTemplate=function(e){return t.divWith(e).firstChild},t.addChildBefore=function(t,e,n){var i,o=!0,a=t.children;if(null!=n&&0!=n.length){for(var s=0;s<a.length;s++)if((i=a[s]).id==n)return t.insertBefore(e,i),void(o=!1);o&&t.appendChild(e)}else t.appendChild(e)},t.remove=function(t){t.parentNode&&t.parentNode.removeChild(t)},t.addChildIfNot=function(t,e){e.parentNode!=t&&t.appendChild(e)},t.bringToTop=function(t){t.parentNode&&t.parentNode.appendChild(t)},t.matches=function(t,e){return o.call(t,e)},t.copyToClipboard=function(t){var e=document.createElement(\"textarea\");e.value=t,document.body.appendChild(e),e.select(),document.execCommand(\"copy\"),document.body.removeChild(e)},t.getBlobURL=function(t,e){var n=new Blob([t],{type:e});return URL.createObjectURL(n)},t.getHtmlBlobUrl=function(e){return t.getBlobURL(e,\"text/html\")},t.removeAllChildren=function(t){for(;t.firstChild;)t.removeChild(t.firstChild)},t.getTextMetrics=function(e,n){null==t.canvas&&(t.canvas=document.createElement(\"canvas\"));var i=t.canvas.getContext(\"2d\");return i.font=n,i.measureText(e)},t.getTextWidth=function(e,n){return t.getTextMetrics(e,n).width},t.isFullScreenEnabled=function(){return document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled},t.closest=function(e,n){var i=e,o=0;do{if(null==i)return null;if(t.matches(i,n))return i;i=i.parentElement}while(o++<1e4)},t.prepend=function(t,e){t.insertBefore(e,t.firstChild)},t}();e.DomUtils=i;var o=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=function(){};e.STORY_STORE=new i;var o=function(){};e.STORE=new o},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(10),o=n(4),a=function(){function t(){this.listeners={}}return t.prototype.getListeners=function(t){return this.listeners[t]},t.prototype.initListeners=function(t){return this.listeners[t]=[],this.listeners[t]},t.getInstance=function(){return null==t.instance&&(t.instance=new t),t.instance},t.addListener=function(e,n){(t.getInstance().getListeners(e)||t.getInstance().initListeners(e)).push(n)},t.prototype.sub=function(t,e){return(this.getListeners(t)||this.initListeners(t)).push(e),this},t.prototype.unsub=function(t,e){var n=this.getListeners(t);if(null!=n)return o.ArrayUtils.removeChild(n,e),this},t.emit=function(e,n){var o=t.getInstance().getListeners(e);o&&o.forEach((function(t){i.Task.order((function(){t(e,n)}))}))},t}();e.EventBus=a},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i,o=function(){function t(){}return t.getRandom=function(t,e){void 0===e&&(e=1);var n=new Array(e),i=t.length,o=new Array(i);if(e>i)throw new RangeError(\"getRandom: more elements taken than available\");for(;e--;){var a=Math.floor(Math.random()*i);n[e]=t[a in o?o[a]:a],o[a]=--i in o?o[i]:i}return n},t.pushUnique=function(t,e){return t.indexOf(e)<0&&t.push(e),t},t.removeChild=function(t,e){var n=t.indexOf(e);n>-1&&t.splice(n,1)},t.remove=function(t,e){return e>-1?t.splice(e,1)[0]:null},t.removeLast=function(t,e){for(;e-- >0;)t.pop()},t.shuffleWithSeed=function(t,e){var n,i;void 0===e&&(e=17);var o,a=t.length;for(n=0;n<a;n++)i=t[o=(e*n+31)%a],t[o]=t[n],t[n]=i;return t},t.shuffle=function(e,n){switch(void 0===n&&(n=i.random),n){case i.same:return e;case i.chaos:return e.sort((function(t,e){return Math.random()-.5}));case i.random:return t.shuffleWithSeed(e,13)}},t.updateArray=function(t,e,n,i){var o,a;(void 0===i&&(i=!0),null!=t&&null!=e&&0!=e.length)&&t.forEach((function(t,i){o=i<e.length?e[i]:a,n(t,o),a=o}))},t}();e.ArrayUtils=o,function(t){t.random=\"random\",t.same=\"same\",t.chaos=\"chaos\"}(i=e.ArrayShuffleOrder||(e.ArrayShuffleOrder={}))},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=function(){};e.GameState=i;var o=function(){this.uiParams=[]};e.GameConfig=o;var a=function(t,e){this.name=t,this.label=e};e.VisibleParameter=a},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(0);e.formatTwinePassageAsHTML=function(t,e){var n=i.WONDER.template,a=function(t,e,n){var i,o,a=[],s=0;for(;s<t.length;){if(-1===(i=t.indexOf(e,s)))return a;-1===(o=t.indexOf(n,i))&&(o=void 0),a.push(t.substring(i+e.length,o)),s=o+n.length}return a}(e,n.choiceStart,n.choiceEnd)[0];e=e.replace(a,n.choiceText).replace(n.choiceStart,\"\").replace(n.choiceEnd,\"\"),t=(t=t.replace(i.REGEXP.twineLink,(function(t,e){var n=(e=e.trim())[0]==i.WONDER.inlineStart;n&&(e=e.substring(1));var a=n?i.LINK_INLINE_TEMPLATE:i.LINK_TEMPLATE;return function(t,e){return e.replace(i.WONDER.template.choiceId,t.id).replace(i.WONDER.template.choiceText,t.text)}(function(t){var e=t.split(\"|\");e[0]=e[0].trim(),null==e[1]&&(e[1]=e[0]);return new o(e[0],e[1])}(e),a)})).trim()).replace(/(?:\\r\\n|\\r|\\n)/g,\"<br>\");var s=e;return s=s.replace(n.text,t.trim())};var o=function(t,e){this.text=t,this.id=e}},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(8),o=n(9),a=n(21),s=n(0),r=i.parseTwineData(),c=new o.GameLogic,l=new a.GameView;l.injectStyle(s.DEFAULT_STYLE),l.injectStyle(r.style),c.loadStory(r)},function(t,e,n){\"use strict\";function i(t){for(var e,n,i,o,a={},s=0,r=t.attributes,c=r.length;s<c;s++)a[(e=r[s].name,n=void 0,i=void 0,o=void 0,n=e.split(\"-\"),i=n.map((function(t,e){return e?t.charAt(0).toUpperCase()+t.slice(1).toLowerCase():t})),o=i.join(\"\"),o)]=r[s].value;return a}Object.defineProperty(e,\"__esModule\",{value:!0}),e.parseTwineData=function(){var t=document.body.querySelector(\"tw-storydata\"),e=i(t);e.style=document.querySelector(\"#twine-user-stylesheet\").innerHTML.trim(),e.script=document.querySelector(\"#twine-user-script\").innerHTML.trim();var n=Array.prototype.slice.call(t.querySelectorAll(\"tw-passagedata\"));return e.passageHash={},e.passages=n.map((function(t){var n,o,a=i(t);return e.passageHash[a.pid],e.passageHash[a.name]=a,e.startnode==a.pid&&(e.startPassageName=a.name),a.content=(n=t.innerHTML.trim(),(o=document.createElement(\"textarea\")).innerHTML=n,0===o.childNodes.length?\"\":o.childNodes[0].nodeValue),a})),e}},function(t,e,n){\"use strict\";var i=this&&this.__assign||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(3),a=n(11),s=n(0),r=n(5),c=n(12),l=n(13),u=n(20),p=n(2),d=function(){function t(){var t=this;this.gameConfig=new r.GameConfig,this.history=new u.WonderHistory,this.isStart=!0,this.isInitialStateLoaded=!1,this.runTime=new l.RunTime,window.w=this.runTime,window.Wonder=window.w,p.STORE.state={passage:null},this.runTime.onStateLoad((function(e){return t.onStateLoad(e)})),o.EventBus.getInstance().sub(\"onPassagePrepared\",(function(e,n){return t.onPassagePrepared(n)})).sub(\"onLinkClick\",(function(e,n){return t.onClick(n)})).sub(\"onBackClick\",(function(e){return t.onBackClick()}))}return t.prototype.loadStory=function(t){p.STORY_STORE.story=t;var e={};this.exeScript(t.script,e),c.WonderStoryParser.parse(t,e,this.gameConfig),this.isInitialStateLoaded?this.setUtilStates(p.STORE.state):this.runTime.setGameVars(e),o.EventBus.emit(\"onStoryLoaded\",t);var n=p.STORE.state.passage||t.startPassageName;this.onClick(n),this.runTime.onStoryReady(),this.isStart=!1},t.prototype.prepareToShow=function(t){o.EventBus.emit(\"preparePassage\",this.getViewPassage(t))},t.prototype.onPassagePrepared=function(t){this.showPassage(t);var e=p.STORE.state;this.runTime.onPassage(t,e)},t.prototype.showPassage=function(t){o.EventBus.emit(\"showPassage\",t)},t.prototype.onClick=function(t){var e=p.STORE.state;this.history.add(e.passage),e.passage=t,this.updateState(),this.prepareToShow(t)},t.prototype.onBackClick=function(){var t=p.STORE.state;this.history.pop(),t.passage=this.history.getLast()||p.STORY_STORE.story.startPassageName,this.updateState(),this.prepareToShow(t.passage)},t.prototype.exeScript=function(t,e){var n=null;try{n=new Function(t).bind(e)()}catch(t){}return n},t.prototype.getViewPassage=function(t){var e=i({},p.STORY_STORE.story.passageHash[t]);return this.execScripts(e),new a.PageViewData(e,this.runTime.getGameVars(),this.gameConfig,this.history,this.history)},t.prototype.execScripts=function(t){var e=this,n=this.runTime.getGameVars();t.content=t.content.replace(s.REGEXP.exeScript,(function(t,i){var o=i.trim(),a=o[0]==s.WONDER.inlineStart;a&&(o=\"return \"+o.substring(1));var r=e.exeScript(o,n);return a?r:\"\"}))},t.prototype.updateState=function(){var t=p.STORE.state;return t.history=this.history.getState(),t.runTime=this.runTime.getState(),t},t.prototype.onStateLoad=function(t){if(null!=t){p.STORE.state=i(i({},p.STORE.state),t);var e=p.STORE.state;0==this.isInitialStateLoaded&&(this.isInitialStateLoaded=!0),this.isStart||(this.setUtilStates(e),this.prepareToShow(e.passage))}},t.prototype.setUtilStates=function(t){this.history.setState(t.history),this.runTime.setState(t.runTime)},t}();e.GameLogic=d},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=requestAnimationFrame?function(t){return requestAnimationFrame(t)}:function(t){return setTimeout(t,0)};e.Task={order:i}},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=function(t,e,n,i,o){this.passage=t,this.state=e,this.config=n,this.viewChecker=i,this.pageCanGoBack=o};e.PageViewData=i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(5),o=n(0),a=function(){function t(){}return t.parse=function(t,e,n){!function(t,e,n){if(null==t)return;(a=t.content,a.split(\"\\n\")).forEach((function(t){0!=(t=t.trim()).length&&function(t,e,n){if(0==function(t,e){return 0==t.indexOf(e)}(t,o.WONDER.markLang.varStart))return;var a=t.split(o.WONDER.markLang.commandSplitter);var s=a[1].trim(),r=a[2]||\"0\",c=a[3];e[s]=parseFloat(r),c&&n.uiParams.push(new i.VisibleParameter(s,c))}(t,e,n)}));var a}(t.passageHash[o.WONDER.passages.config],e,n)},t}();e.WonderStoryParser=a},function(t,e,n){\"use strict\";var i=this&&this.__assign||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(14),a=n(15),s=n(18),r=n(19),c=n(2),l=function(){function t(){var t=this;this.autosave=this.autoSave,this.gameVars={},this.audioPlayer=new s.AudioPlayer,this.collections=new a.Collections,this.postMessageApi=new o.PostMessageApi,this.saveApi=new r.SaveApi,this.postMessageApi.on(\"load\",(function(e){t.saveApi.loadFrom(e)})),this.saveApi.dataGetter=function(){return c.STORE.state}}return t.prototype.onStateLoad=function(t){this.saveApi.dataHandler=t},t.prototype.getGameVars=function(){return this.gameVars},t.prototype.setGameVars=function(t){this.gameVars=i({},t)},t.prototype.updateGameVars=function(t){this.gameVars=i(i({},this.gameVars),t)},t.prototype.setState=function(t){null!=t&&(this.setGameVars(t.gameVars),this.collections.loadState(t.collections))},t.prototype.getState=function(){return{gameVars:this.gameVars,collections:this.collections.getState()}},t.prototype.styleUrl=function(t){var e=document.createElement(\"link\");e.setAttribute(\"rel\",\"stylesheet\"),e.setAttribute(\"href\",t),document.head.appendChild(e)},t.prototype.collect=function(t){this.collections.addRule(t)},t.prototype.music=function(t,e){void 0===e&&(e=1),this.audioPlayer.music(t,e)},t.prototype.musicFor=function(t,e,n){void 0===n&&(n=1),this.audioPlayer.musicFor(t,e,n)},t.prototype.sound=function(t,e){void 0===e&&(e=1),this.audioPlayer.sound(t,e)},t.prototype.musicStop=function(){this.audioPlayer.stop()},t.prototype.parentApi=function(){return this.postMessageApi},t.prototype.disableLocalSave=function(t){void 0===t&&(t=!0),this.saveApi.disable(t)},t.prototype.autoSave=function(t){void 0===t&&(t=!0),this.saveApi.autoSave(t)},t.prototype.saveSlot=function(t){this.saveApi.saveSlot(t)},t.prototype.save=function(t){this.parentApi().send(\"passage\",c.STORE.state),this.saveApi.save(t)},t.prototype.load=function(t){this.saveApi.load(t)},t.prototype.onStoryReady=function(){var t=this;setTimeout((function(){t.collections.onStoryReady()}),0)},t.prototype.onPassage=function(t,e){this.audioPlayer.musicCheck(t.name),this.collections.onPassage(t),this.saveApi.onPassage()},t}();e.RunTime=l},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=function(){function t(t,e){var n=this;void 0===t&&(t=null),void 0===e&&(e=\"*\"),this.isDisabled=!0,this.listenerMap={},this.parent=t,null==this.parent&&(this.parent=window.parent),this.targetOrigin=e,window.addEventListener(\"message\",(function(t){return n.onMessage(t)}))}return t.prototype.enable=function(){this.isDisabled=!1},t.prototype.disable=function(){this.isDisabled=!0},t.prototype.send=function(t,e){if(!this.isDisabled){var n={name:t,data:e};this.parent&&this.parent.postMessage(n,this.targetOrigin)}},t.prototype.on=function(t,e){null==this.listenerMap[t]&&(this.listenerMap[t]=[]),this.listenerMap[t].push(e)},t.prototype.onMessage=function(t){if(!this.isDisabled){var e=t.data,n=this.listenerMap[e.name];n&&n.forEach((function(t){return t(e.data)}))}},t}();e.PostMessageApi=i},function(t,e,n){\"use strict\";var i=this&&this.__assign||function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(16),a=n(2),s=function(){function t(){this.rulesMap={},this.collectionMap={},this.collectionsView=new o.CollectionsView}return t.prototype.onStoryReady=function(){var t=this;this.initCollections(),setTimeout((function(){t.collectionsView.createViews(t.collectionMap)}),500)},t.prototype.loadState=function(t){this.collectionMap=i(i({},this.collectionMap),t.collected),this.collectionsView.updateButtons(this.collectionMap)},t.prototype.getState=function(){return{collected:this.collectionMap}},t.prototype.addRule=function(t){var e=this;t.tags.forEach((function(n){null==e.rulesMap[n]&&(e.rulesMap[n]=[]),e.rulesMap[n].push(t)})),this.addCollection(t)},t.prototype.onPassage=function(t){var e=this;this.getTags(t).forEach((function(n){return e.collectTag(n,t)}))},t.prototype.collectTag=function(t,e){var n=this,i=this.rulesMap[t];null==i||i.length<1||i.forEach((function(t){return n.collectByRule(t,e)}))},t.prototype.collectByRule=function(t,e){var n=this.collectionMap[t.collection];n.collected.indexOf(e.name)<0&&(n.collected.push(e.name),this.onPassageCollected(e,n))},t.prototype.onPassageCollected=function(t,e){this.collectionsView.updateButton(e)},t.prototype.addCollection=function(t){this.collectionMap[t.collection],this.collectionMap[t.collection]={name:t.collection,title:t.title,collected:[],maxAmount:0}},t.prototype.initCollections=function(){var t=this,e=a.STORY_STORE.story;Object.keys(this.collectionMap).forEach((function(e){t.collectionMap[e].maxAmount=0})),e.passages.forEach((function(e){t.getTags(e).forEach((function(e){var n=t.rulesMap[e];null!=n&&n.forEach((function(e){var n=t.collectionMap[e.collection];null!=n&&n.maxAmount++}))}))}))},t.prototype.getTags=function(t){return t.tags.split(\" \")},t}();e.Collections=s},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(17),o=n(1),a=function(){function t(){var t=this;this.isViewCreated=!1,this.viewMap={},this.buttonWrapper=document.createElement(\"div\"),this.buttonWrapper.id=\"c-wrapper\",this.buttonWrapper.addEventListener(\"mouseup\",(function(e){return t.findButton(e)})),this.shadow=document.createElement(\"div\"),this.shadow.id=\"c-shadow\",this.shadow.style.display=\"none\",this.shadow.style.position=\"absolute\",this.shadow.style.width=\"100%\",this.shadow.style.height=\"100%\",this.shadow.style.background=\"#000\",this.shadow.style.opacity=\"0.3\",this.shadow.addEventListener(\"mouseup\",(function(e){return t.closeAll()}))}return t.prototype.createViews=function(t){var e=this;document.body.appendChild(this.shadow),Object.keys(t).forEach((function(n){var o=t[n],a=new i.SingleCollectionView;e.viewMap[n]=a,a.update(o),a.onCollectionShow((function(t){return e.onCollectionShow(t)})),a.attach(e.buttonWrapper)})),this.isViewCreated=!0,document.body.appendChild(this.buttonWrapper)},t.prototype.updateButtons=function(t){var e=this;Object.keys(t).forEach((function(n){var i=t[n];e.updateButton(i)}))},t.prototype.updateButton=function(t){if(this.isViewCreated){var e=this.viewMap[t.name];null!=e&&e.update(t)}},t.prototype.onCollectionShow=function(t){var e=this;Object.keys(this.viewMap).forEach((function(n){t!=n&&e.viewMap[n].closeCollection()}))},t.prototype.findButton=function(t){var e=this,n=o.DomUtils.closest(t.target,\".c-button\");if(n){var i=n.dataset.collection;Object.keys(this.viewMap).forEach((function(t){var n=e.viewMap[t];null!=n&&(t==i?(e.shadow.style.display=\"block\",n.showCollection()):n.closeCollection())}))}},t.prototype.closeAll=function(){var t=this;Object.keys(this.viewMap).forEach((function(e){t.viewMap[e].closeCollection()})),this.shadow.style.display=\"none\"},t}();e.CollectionsView=a},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(2),o=n(6),a=n(0),s=n(1),r=function(){function t(t,e,n){void 0===t&&(t=\"c-button\"),void 0===e&&(e=\"c-list\"),void 0===n&&(n=\"c-page\"),this.buttonClass=t,this.listClass=e,this.pageClass=n,this.buttonEl=this.createButton(t),this.listEl=this.createList(e),this.pageEl=this.createPage(n)}return t.prototype.attach=function(t){t=t||document.body,document.body.appendChild(this.listEl),document.body.appendChild(this.pageEl),t.appendChild(this.buttonEl)},t.prototype.update=function(t){this.updateButton(t),this.updateListTitle(t),this.updateList(t)},t.prototype.onCollectionShow=function(t){this.onButtonClickCallback=t},t.prototype.createButton=function(t){var e=this.createDiv(t);return this.buttonTitleEl=this.createDiv(\"c-bt-title\"),this.buttonContentEl=this.createDiv(\"c-bt-content\"),e.appendChild(this.buttonTitleEl),e.appendChild(this.buttonContentEl),e},t.prototype.createList=function(t){var e=this,n=this.createDiv(t);return n.addEventListener(\"click\",(function(t){return e.findItem(t)})),this.listTitleEl=this.createDiv(\"c-list-title\"),this.listContentEl=this.createDiv(\"c-list-content\"),n.appendChild(this.listTitleEl),n.appendChild(this.listContentEl),n},t.prototype.createPage=function(t){var e=this,n=this.createDiv(t);return n.addEventListener(\"mouseup\",(function(){return e.closePage()})),n},t.prototype.updateButton=function(t){var e=this.buttonEl,n=this.buttonTitleEl,i=this.buttonContentEl;this.collectionName=t.name;var o=t.collected.length,a=t.maxAmount,s=t.title;e.dataset.collection=this.collectionName,n.innerHTML=\"\"+s,i.innerHTML=o+\"/\"+a;var r=o==a?\"c-button-completed\":\"\";e.className=\"c-button \"+this.collectionName+\" \"+r},t.prototype.updateListTitle=function(t){this.listTitleEl.innerHTML=t.title},t.prototype.updateList=function(t){var e=this,n=this.listEl,o=this.listContentEl;o.innerHTML=\"\";var a=i.STORY_STORE.story.passageHash,s=\"\";t.collected.forEach((function(t){var n=a[t],i=e.getPageTitle(n.content),o=e.getItemTemplate(i,t);s+=o})),o.innerHTML=s,n.className=\"c-list \"+this.collectionName},t.prototype.updatePage=function(t){var e=this.pageEl;e.innerHTML=\"\";var n=t.content.replace(a.REGEXP.exeScript,\"\"),i=a.PASSAGE_TEMPLATE,s=o.formatTwinePassageAsHTML(n,i);e.innerHTML=s},t.prototype.showCollection=function(){this.listEl.classList.add(\"c-list-show\"),this.onCollectionShow&&this.onButtonClickCallback(this.collectionName)},t.prototype.closeCollection=function(){this.listEl.classList.remove(\"c-list-show\"),this.closePage()},t.prototype.findItem=function(t){var e=s.DomUtils.closest(t.target,\".c-item\");e&&this.onItemClick(e.dataset.name)},t.prototype.onItemClick=function(t){var e=i.STORY_STORE.story.passageHash[t];e!=t&&(this.updatePage(e),this.showPage())},t.prototype.getPageTitle=function(t){var e=function(t,e,n,i){void 0===i&&(i=!1);var o=t.indexOf(e);if(o<0)return\"\";var a=t.indexOf(n,o),s=i?0:e.length,r=i?n.length:0;return t.substring(o+s,a+r)}(t,\"<h1>\",\"</h1>\");return null!=e&&0!=e.length||(e=function(t){var e=t.indexOf(\"\\n\");if(-1===e)return t;return t.substr(0,e)}(t)),e},t.prototype.showPage=function(){this.pageEl.classList.add(\"c-page-show\")},t.prototype.closePage=function(){this.pageEl.classList.remove(\"c-page-show\")},t.prototype.createDiv=function(t){var e=document.createElement(\"div\");return e.className=t,e},t.prototype.getItemTemplate=function(t,e){return'<div class=c-item data-name=\"'+e+'\">'+t+\"</div>\"},t}();e.SingleCollectionView=r},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=function(){function t(){this.musicHash={},this.audioElement=new Audio}return t.prototype.music=function(t,e){this.audioElement.loop=!0,this.play(t,e)},t.prototype.sound=function(t,e){this.audioElement.loop=!1,this.play(t,e)},t.prototype.musicFor=function(t,e,n){this.musicHash[t]={url:e,volume:n}},t.prototype.musicCheck=function(t){var e=this.musicHash[t];null!=e&&this.music(e.url,e.volume)},t.prototype.play=function(t,e){var n=t.trim();this.lastUrl=n,this.audioElement.src=this.lastUrl,this.audioElement.volume=e,(this.audioElement.paused||n!=this.lastUrl)&&this.audioElement.play().then((function(t){}))},t.prototype.stop=function(){this.audioElement.pause()},t}();e.AudioPlayer=i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=function(){function t(){this.saveName=\"autoSave\",this.isAuto=!0,this.isDisabled=!1}return t.prototype.enable=function(){this.isDisabled=!1},t.prototype.disable=function(t){void 0===t&&(t=!0),this.isDisabled=t},t.prototype.autoSave=function(t){void 0===t&&(t=!0),this.isAuto=t},t.prototype.saveSlot=function(t){this.saveName=t},t.prototype.save=function(t){if(void 0===t&&(t=this.saveName),null!=this.dataGetter&&!this.isDisabled){var e=this.dataGetter();localStorage.setItem(t,JSON.stringify(e))}},t.prototype.load=function(t){if(void 0===t&&(t=this.saveName),!this.isDisabled&&null!=this.dataHandler){var e=JSON.parse(localStorage.getItem(t));this.dataHandler(e)}},t.prototype.loadFrom=function(t){this.dataHandler(t)},t.prototype.onPassage=function(){this.isDisabled||this.isAuto&&this.save(this.saveName)},t}();e.SaveApi=i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=function(){function t(){this.clear()}return t.prototype.getState=function(){return{pages:this.pages,pagesHash:this.pagesHash}},t.prototype.setState=function(t){null!=t&&(this.pages=t.pages,this.pagesHash=t.pagesHash)},t.prototype.clear=function(){this.pages=[],this.pagesHash={}},t.prototype.add=function(t){null!=t&&this.getLast()!=t&&(this.pages.push(t),this.pagesHash[t]=!0)},t.prototype.isViewed=function(t){return 1==this.pagesHash[t]},t.prototype.pop=function(){return this.pages.pop()},t.prototype.canGoBack=function(t){if(!(this.pages.length>0))return!1;var e=1==this.pages.length,n=this.pages[0]&&this.pages[0]==t;return!(e&&n)},t.prototype.getLast=function(){return this.pages[this.pages.length-1]},t}();e.WonderHistory=i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(3),o=n(0),a=n(22),s=n(1),r=function(){function t(){var t=this;this.el=document.createElement(\"div\"),this.el.id=o.WONDER.contentId,document.body.appendChild(this.el),this.el.addEventListener(\"click\",this),this.pageView=new a.WonderPageView(this.el),i.EventBus.getInstance().sub(\"onStoryLoaded\",(function(e,n){return t.onStoryLoaded(n)})).sub(\"preparePassage\",(function(e,n){return t.preparePassage(n)})).sub(\"showPassage\",(function(e,n){return t.showPassage(n)}))}return t.prototype.handleEvent=function(t){this.checkLinkClick(t)||this.checkBackClick(t)},t.prototype.checkClick=function(t,e,n){var i=s.DomUtils.closest(t.target,e);return i&&n(i,t),null!=i},t.prototype.checkLinkClick=function(t){return this.checkClick(t,\".\"+o.WONDER.linkClass,(function(t,e){var n=t.dataset.id;i.EventBus.emit(\"onLinkClick\",n)}))},t.prototype.checkBackClick=function(t){return this.checkClick(t,\".\"+o.WONDER.backClass,(function(t,e){i.EventBus.emit(\"onBackClick\",null)}))},t.prototype.injectStyle=function(t){if(0!=t.length){var e=document.createElement(\"style\");e.innerHTML=t,document.getElementsByTagName(\"head\")[0].appendChild(e)}},t.prototype.onStoryLoaded=function(t){},t.prototype.preparePassage=function(t){var e=t.passage,n=this.pageView.addNextPage(e);this.setPageNameAsBodyId(t),this.markVisitedLinks(n,t.viewChecker),this.showBackLink(n,t.pageCanGoBack,e),this.injectParams(n,t.config.uiParams,t.state),i.EventBus.emit(\"onPassagePrepared\",e)},t.prototype.setPageNameAsBodyId=function(t){document.body.id=t.passage.name,document.body.className=t.passage.tags},t.prototype.showPassage=function(t){this.pageView.showNextPage()},t.prototype.injectParams=function(t,e,n){e.forEach((function(e){var i=e.name,o=n[e.name],a=t.querySelector(e.name);a&&(a.innerHTML=i+\":\"+o)}))},t.prototype.markVisitedLinks=function(t,e){for(var n,i,a=t.querySelectorAll(\".\"+o.WONDER.linkClass),s=0;s<a.length;s++)i=(n=a[s]).dataset.id,e.isViewed(i)&&n.classList.add(o.WONDER.visitedClass)},t.prototype.showBackLink=function(t,e,n){var i=t.querySelector(\".\"+o.WONDER.backClass);null!=i&&(e.canGoBack(n.name)?i.classList.remove(o.WONDER.invisibleClass):i.classList.add(o.WONDER.invisibleClass))},t}();e.GameView=r},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(23),o=n(3),a=n(26),s=n(0),r=n(6),c=function(){function t(t){var e=this;this.parent=t,this.pageView=new i.PagePairView,this.pageBuilder=new a.ViewBuilder(s.PAGE_TEMPLATE),this.contentBuilder=new a.ViewBuilder(s.PASSAGE_TEMPLATE),this.contentBuilder.setContentFormatter(r.formatTwinePassageAsHTML),o.EventBus.getInstance().sub(\"onPageFormatLoaded\",(function(t,n){return e.pageBuilder.setTemplate(n)})).sub(\"onPassageFormatLoaded\",(function(t,n){return e.contentBuilder.setTemplate(n)}))}return t.prototype.addNextPage=function(t){var e=this.buildPageView(t);return this.pageView.addPage(e),e},t.prototype.showNextPage=function(){this.pageView.next()},t.prototype.buildPageView=function(t){var e=t.content,n=this.contentBuilder.build(e),i=this.pageBuilder.build();return i.classList.add(s.COMMON_CSS.displayNone),i.appendChild(n),this.parent.appendChild(i),i},t}();e.WonderPageView=c},function(t,e,n){\"use strict\";var i,o=this&&this.__extends||(i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,\"__esModule\",{value:!0});var a=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.limit=2,e}return o(e,t),e.prototype.addPage=function(e){t.prototype.addPage.call(this,e),this.pages.length>this.limit&&(this.currentPage--,this.dropPage(0))},e}(n(24).PageView);e.PagePairView=a},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(25),o=n(4),a=n(1),s=function(){function t(){this.pages=[],this.currentPage=-1,this.animator=new i.PageAnimator}return t.prototype.setAnimator=function(t){this.animator=t},t.prototype.addPage=function(t){this.pages.push(t)},t.prototype.next=function(){var t=this.getCurrent();this.currentPage++,this.setCurrent(this.currentPage);var e=this.getCurrent();this.switch(t,e)},t.prototype.previous=function(){var t=this.getCurrent();this.currentPage--,this.setCurrent(this.currentPage);var e=this.getCurrent();this.switch(t,e)},t.prototype.switch=function(t,e){t&&this.animator.hide(t),this.animator.show(e)},t.prototype.getCurrent=function(){return this.pages[this.currentPage]},t.prototype.setCurrent=function(t){if(0==this.pages.length)throw\"setCurrent error - void pages\";var e=this.pages.length-1;t>e?t=0:t<0&&(t=e),this.currentPage=t},t.prototype.dropPage=function(t){var e=o.ArrayUtils.remove(this.pages,t);null!=e&&a.DomUtils.remove(e)},t}();e.PageView=s},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(0),o=function(){function t(){}return t.prototype.show=function(t,e){void 0===e&&(e=0),t.classList.remove(i.COMMON_CSS.displayNone)},t.prototype.hide=function(t,e){void 0===e&&(e=0),t.classList.add(i.COMMON_CSS.displayNone)},t}();e.PageAnimator=o},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(1),o=function(){function t(t){this.template=t,this.contentFormatter=function(t,e){return e}}return t.prototype.setTemplate=function(t){this.template=t},t.prototype.setContentFormatter=function(t){this.contentFormatter=t},t.prototype.build=function(t){void 0===t&&(t=\"\");var e=this.contentFormatter(t,this.template);return i.DomUtils.elementFromTemplate(e)},t}();e.ViewBuilder=o}]);"+ '</script>' +
    '        </body>\n' +
    '    </html>';


window.storyFormat({
    name: 'twine-wonder',
    version: '0.6.13',
    author: 'Kvisaz [Sergey Tokarev]',
    description: 'Twine Wonder Format',
    proofing: false,
    url: 'https://github.com/Kvisaz/twine-wonder',
    image: 'icon.svg',
    source: SOURCE,
});
