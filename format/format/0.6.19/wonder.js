var SOURCE = '<!DOCTYPE html>\n' +
    '    <html>\n' +
    '        <head>\n' +
    '            <meta name="viewport" content="width=device-width, initial-scale=1">\n' +
    '            <meta charset="utf-8">\n' +
    '            <title>{{STORY_NAME}}</title>\n' +
    '            <style></style>\n' +
    '        </head>\n' +
    '        <body>\n' +
    '            <tw-story tags></tw-story>\n' +
    '            {{STORY_DATA}}\n' +
    '            <script>' + "!function(t){var e={};function n(o){if(e[o])return e[o].exports;var a=e[o]={i:o,l:!1,exports:{}};return t[o].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(t,\"__esModule\",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&\"object\"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,\"default\",{enumerable:!0,value:t}),2&e&&\"string\"!=typeof t)for(var a in t)n.d(o,a,function(e){return t[e]}.bind(null,a));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,\"a\",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p=\"\",n(n.s=7)}([function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0}),e.STORY_SELECTOR=\"tw-storydata\",e.PASSAGE_SELECTOR=\"tw-passagedata\",e.COMMON_CSS={displayNone:\"displayNone\",pointerOver:\"pointerOver\",visited:\"visited\",back:\"back\"},e.WONDER={preloadId:\"preload\",preloadAnchorId:\"preload-anchor\",contentId:\"wonder-content\",pageClass:\"page\",pageContentClass:\"page-content\",textClass:\"text\",choiceClass:\"choice\",inlineClass:\"inline\",linkClass:\"link\",linkAloneClass:\"link-alone\",newLineClass:\"newLine\",linkInlineClass:\"inline\",noSelectClass:\"noselect\",selectClass:\"select\",paramClass:\"params\",visitedClass:e.COMMON_CSS.visited,backClass:e.COMMON_CSS.back,invisibleClass:e.COMMON_CSS.displayNone,template:{text:\"<text/>\",choices:\"<choices/>\",choiceStart:\"<choice>\",choiceEnd:\"</choice>\",choiceText:\"<choice-text/>\",choiceId:\"<choice-id/>\"},passages:{config:\"wonder.config\",pageFormat:\"wonder.format.page\",choiceFormat:\"wonder.format.choice\",textFormat:\"wonder.format.text\"},markLang:{varStart:\"var\",commandSplitter:\":\"},inlineStart:\"=\"};e.REGEXP={exeScript:new RegExp(\"{{([\\\\s\\\\S]*?)}}\",\"g\"),twineLink:new RegExp(\"\\\\[\\\\[([\\\\s\\\\S]*?)\\\\]\\\\]\",\"g\")},e.PRELOAD_PAGE_TEMPLATE=\"<div id=\"+e.WONDER.preloadAnchorId+\"></div>\",e.PAGE_TEMPLATE='<div class=\"'+e.WONDER.noSelectClass+\" \"+e.WONDER.pageClass+'\"></div>',e.LINK_TEMPLATE='<span class=\"'+e.WONDER.linkClass+\"  \"+e.WONDER.linkAloneClass+'\" data-id=\"'+e.WONDER.template.choiceId+'\">'+e.WONDER.template.choiceText+\"</span>\",e.LINK_INLINE_TEMPLATE='<span class=\"'+e.WONDER.linkClass+'\" data-id=\"'+e.WONDER.template.choiceId+'\">'+e.WONDER.template.choiceText+\"</span>\",e.BACK_TEMPLATE='<div class=\"'+e.WONDER.backClass+'\">Назад</div>',e.PASSAGE_TEMPLATE='<div class=\"'+e.WONDER.pageContentClass+'\">\\n'+e.BACK_TEMPLATE+'\\n<div class=\"'+e.WONDER.paramClass+'\" ><div id=\"gold\"></div></div>\\n<div class=\"'+e.WONDER.textClass+'\"><text/></div>\\n</div>',e.DEFAULT_STYLE='\\n     * {user-select: none;}\\n    .noselect { user-select: none; }    \\n    .select {  user-select: text; }\\n    .page .displayNone, .displayNone {\\n        display: none; \\n    }\\n    html, body{height: 100%}\\n    .pointerOver {\\n        cursor: pointer;\\n    }\\n    \\n    ul, li {\\n        margin: 0;\\n        padding: 0;\\n        list-style: none;\\n    }\\n    \\n    body {\\n        margin: 0;\\n        padding: 0;\\n        background: #ceceb7;\\n        font-family: \"Verdana\", \"Roboto\", \"Open Sans\", sans-serif;\\n        position: relative;\\n        display: flex;\\n        justify-content: center;\\n        align-items: start;\\n    }\\n    \\n    .'+e.WONDER.newLineClass+\" {\\n        display: block;\\n    }\\n    \\n    #\"+e.WONDER.contentId+\" {\\n        width: 800px;\\n        border-radius: 0 0 8px 8px;\\n        overflow: hidden;\\n    }\\n    \\n    .\"+e.WONDER.pageClass+\" {\\n          background: beige;          \\n     }\\n     \\n     #\"+e.WONDER.preloadId+\" .\"+e.WONDER.pageClass+\" {\\n        background: none;\\n     }\\n     \\n     .\"+e.WONDER.pageContentClass+\" {\\n          display: flex;\\n          flex-direction: column;\\n          padding: 12px;\\n     }\\n        \\n    .\"+e.WONDER.paramClass+\"{\\n        margin-bottom: 12px;\\n    }\\n        \\n        \\n    .\"+e.WONDER.textClass+\" {\\n        margin: 0;\\n        font-size: 18px;\\n        line-height: 26px;\\n    }\\n    \\n    .\"+e.WONDER.linkClass+\"{\\n        display: block;\\n        cursor: pointer;\\n        padding: 5px 35px;\\n        border-radius: 5px;\\n        background: #d5c695;\\n    }   \\n    \\n    .\"+e.WONDER.inlineClass+\" .\"+e.WONDER.linkClass+\"{\\n        display: inline;\\n        cursor: pointer;\\n        padding: 5px 35px;\\n        border-radius: 5px;\\n        background: #d5c695;\\n    }  \\n    \\n        \\n    .\"+e.WONDER.linkClass+\":hover, .\"+e.WONDER.backClass+\":hover{\\n        color: #4b0d1e;\\n        background: #d5b562;       \\n    }\\n    \\n    .\"+e.WONDER.visitedClass+\":after {\\n        content: '  (прочитано)';\\n        font-size: smaller;\\n     }\\n     \\n     .\"+e.WONDER.visitedClass+\" {\\n        opacity: 0.65;\\n        font-size: smaller;\\n     }\\n    \\n    .\"+e.WONDER.backClass+\" {\\n        cursor: pointer;\\n        display: inline-block;\\n        margin-left: 0;\\n        margin-right: auto;\\n        margin-bottom: 4px;\\n        padding: 4px;\\n        border-radius: 5px;\\n        background: #eae2c5;\\n        color: #6c6c6c;\\n    }\\n    \\n     .\"+e.WONDER.backClass+\":before {\\n        content: '<';\\n     }\\n   \\n    \\n    .\"+e.WONDER.linkAloneClass+\"{\\n        margin-top: 0px;\\n    }\\n    \\n    .\"+e.WONDER.linkAloneClass+\":hover{\\n        margin-top: -2px;\\n        margin-bottom: 2px;\\n        box-shadow: 2px 2px 1px #414141;\\n    }\\n    \\n    #c-wrapper{\\n        position: absolute;\\n        display: flex;\\n        flex-direction: column;\\n        top: 0;\\n        left: 0;\\n    }\\n    \\n    .c-button{\\n        width: 96px;     \\n        line-height: 1em;\\n        background: antiquewhite;\\n        margin-top: 24px;\\n        text-align: center;\\n        cursor: pointer;\\n        box-shadow: 1px 2px 6px black;\\n    }\\n    \\n    .c-button:hover {\\n        transform: scale(1.09) translateX(4px);\\n        box-shadow: 1px 2px 6px black;\\n    }\\n    \\n    .c-bt-title{\\n        font-size: 16px;\\n        text-align: center;\\n        height: 1em;\\n        line-height: 1em;\\n        background: #b66e13;\\n        margin-bottom: 12px;\\n        padding: 2px;\\n    }\\n    \\n    .c-bt-content{\\n        font-size: 24px;\\n        text-align: center;\\n        height: 1em;\\n        line-height: 1em;\\n        margin-bottom: 12px;\\n    }\\n    \\n    .c-list{\\n        position: absolute;\\n        height: 89%;\\n        width: 800px;        \\n        top: 10%;\\n        left: 0;\\n        transform: translate(-100%, 0);\\n        background: #876b38;\\n        transition-duration: 0.45s;\\n        animation-timing-function: ease-out;\\n        box-shadow: 1px 2px 6px rgba(0,0,0,0.65);\\n    }\\n    \\n    .c-list-show{\\n        left: 50%;\\n        transform: translate(-49%, 0);\\n    }\\n    \\n    .c-list-title{\\n        font-size: 32px;    \\n         color: antiquewhite;   \\n        margin: 12px;\\n     }\\n        \\n    .c-list-content{\\n        font-size: 24px;\\n        overflow: auto;\\n        padding: 12px;\\n        background: #d7d7c5;\\n        border: 1px solid #afafaf;\\n        height: 90%;\\n    }\\n    .c-item{ \\n         padding: 12px;\\n         border: 1px solid #afafaf;\\n         cursor: pointer;\\n         background: beige;\\n         border-radius: 4px;\\n         margin-top: 6px;\\n    }\\n    \\n    .c-item:hover {\\n        transform: scale(1.01);\\n        background: #fffffc;\\n        box-shadow: 1px 2px 6px rgba(0,0,0,0.65);\\n    }   \\n    \\n    .c-list-content::-webkit-scrollbar { width: 32px; }\\n        \\n    .c-list-content::-webkit-scrollbar-track {\\n        background: #d0ac75;\\n        border-radius: 16px;    \\n    }\\n    .c-list-content::-webkit-scrollbar-thumb {\\n          background-color: #f1760c;   \\n          border-radius: 20px;       \\n          border: 2px solid #6f3909; \\n    }\\n    \\n    .c-page{\\n        position: absolute;\\n        height: 95%;\\n        width: 800px;        \\n        top: 3%;\\n        left: 0;\\n        transform: translate(-100%, 0);        \\n        background: beige;\\n        overflow: auto;\\n        transition-duration: 0.45s;\\n        animation-timing-function: ease-out;\\n        box-shadow: 1px 2px 6px rgba(0,0,0,0.65);\\n    }\\n    \\n    .c-page-content{\\n        margin: 12px 12px 16px;\\n    }\\n    \\n    .c-page-show{\\n        left: 50%;\\n        transform: translate(-47%, 0);\\n    }\\n    \\n    .c-page::-webkit-scrollbar { width: 32px; }\\n        \\n    .c-page::-webkit-scrollbar-track {\\n        background: #d0ac75;\\n        border-radius: 16px;    \\n    }\\n    .c-page::-webkit-scrollbar-thumb {\\n          background-color: #ce9643;   \\n          border-radius: 20px;       \\n          border: 2px solid #efd0a6; \\n    }\\n    \\n    @media screen and (max-width: 800px){\\n        .\"+e.WONDER.contentId+\" {\\n             width: 100%;\\n             margin: 0;\\n             border-radius: 0;\\n        }\\n    }\\n\"},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=function(){};e.STORY_STORE=new o;var a=function(){};e.STORE=new a;var i=function(){this.hasSave=!1,this.textBuffer=[],this.commands=[]};e.RUNTIME_STORE=new i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=function(){function t(){}return t.divWith=function(t){var e=document.createElement(\"div\");return e.innerHTML=t,e},t.elementFromTemplate=function(e){return t.divWith(e).firstChild},t.addChildBefore=function(t,e,n){var o,a=!0,i=t.children;if(null!=n&&0!=n.length){for(var r=0;r<i.length;r++)if((o=i[r]).id==n)return t.insertBefore(e,o),void(a=!1);a&&t.appendChild(e)}else t.appendChild(e)},t.remove=function(t){t.parentNode&&t.parentNode.removeChild(t)},t.addChildIfNot=function(t,e){e.parentNode!=t&&t.appendChild(e)},t.bringToTop=function(t){t.parentNode&&t.parentNode.appendChild(t)},t.matches=function(t,e){return a.call(t,e)},t.copyToClipboard=function(t){var e=document.createElement(\"textarea\");e.value=t,document.body.appendChild(e),e.select(),document.execCommand(\"copy\"),document.body.removeChild(e)},t.getBlobURL=function(t,e){var n=new Blob([t],{type:e});return URL.createObjectURL(n)},t.getHtmlBlobUrl=function(e){return t.getBlobURL(e,\"text/html\")},t.removeAllChildren=function(t){for(;t.firstChild;)t.removeChild(t.firstChild)},t.getTextMetrics=function(e,n){null==t.canvas&&(t.canvas=document.createElement(\"canvas\"));var o=t.canvas.getContext(\"2d\");return o.font=n,o.measureText(e)},t.getTextWidth=function(e,n){return t.getTextMetrics(e,n).width},t.isFullScreenEnabled=function(){return document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled},t.closest=function(e,n){var o=e,a=0;do{if(null==o)return null;if(t.matches(o,n))return o;o=o.parentElement}while(a++<1e4)},t.prepend=function(t,e){t.insertBefore(e,t.firstChild)},t}();e.DomUtils=o;var a=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(9),a=n(4),i=function(){function t(){this.listeners={}}return t.prototype.getListeners=function(t){return this.listeners[t]},t.prototype.initListeners=function(t){return this.listeners[t]=[],this.listeners[t]},t.getInstance=function(){return null==t.instance&&(t.instance=new t),t.instance},t.addListener=function(e,n){(t.getInstance().getListeners(e)||t.getInstance().initListeners(e)).push(n)},t.prototype.sub=function(t,e){return(this.getListeners(t)||this.initListeners(t)).push(e),this},t.prototype.unsub=function(t,e){var n=this.getListeners(t);if(null!=n)return a.ArrayUtils.removeChild(n,e),this},t.emit=function(e,n){var a=t.getInstance().getListeners(e);a&&a.forEach((function(t){o.Task.order((function(){t(e,n)}))}))},t}();e.EventBus=i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o,a=function(){function t(){}return t.getRandom=function(t,e){void 0===e&&(e=1);var n=new Array(e),o=t.length,a=new Array(o);if(e>o)throw new RangeError(\"getRandom: more elements taken than available\");for(;e--;){var i=Math.floor(Math.random()*o);n[e]=t[i in a?a[i]:i],a[i]=--o in a?a[o]:o}return n},t.pushUnique=function(t,e){return t.indexOf(e)<0&&t.push(e),t},t.removeChild=function(t,e){var n=t.indexOf(e);n>-1&&t.splice(n,1)},t.remove=function(t,e){return e>-1?t.splice(e,1)[0]:null},t.removeLast=function(t,e){for(;e-- >0;)t.pop()},t.shuffleWithSeed=function(t,e){var n,o;void 0===e&&(e=17);var a,i=t.length;for(n=0;n<i;n++)o=t[a=(e*n+31)%i],t[a]=t[n],t[n]=o;return t},t.shuffle=function(e,n){switch(void 0===n&&(n=o.random),n){case o.same:return e;case o.chaos:return e.sort((function(t,e){return Math.random()-.5}));case o.random:return t.shuffleWithSeed(e,13)}},t.updateArray=function(t,e,n,o){var a,i;(void 0===o&&(o=!0),null!=t&&null!=e&&0!=e.length)&&t.forEach((function(t,o){a=o<e.length?e[o]:i,n(t,a),i=a}))},t}();e.ArrayUtils=a,function(t){t.random=\"random\",t.same=\"same\",t.chaos=\"chaos\"}(o=e.ArrayShuffleOrder||(e.ArrayShuffleOrder={}))},function(t,e,n){\"use strict\";function o(){return document.querySelector(\"#twine-user-stylesheet\").innerHTML.trim()}function a(t){for(var e,n,o,a,i={},r=0,s=t.attributes,c=s.length;r<c;r++)i[(e=s[r].name,n=void 0,o=void 0,a=void 0,n=e.split(\"-\"),o=n.map((function(t,e){return e?t.charAt(0).toUpperCase()+t.slice(1).toLowerCase():t})),a=o.join(\"\"),a)]=s[r].value;return i}Object.defineProperty(e,\"__esModule\",{value:!0}),e.parseTwineData=function(){var t=document.body.querySelector(\"tw-storydata\"),e=a(t);e.style=o(),e.script=document.querySelector(\"#twine-user-script\").innerHTML.trim();var n=Array.prototype.slice.call(t.querySelectorAll(\"tw-passagedata\"));return e.passageHash={},e.passages=n.map((function(t){var n,o,i=a(t);return e.passageHash[i.pid],e.passageHash[i.name]=i,e.startnode==i.pid&&(e.startPassageName=i.name),i.content=(n=t.innerHTML.trim(),(o=document.createElement(\"textarea\")).innerHTML=n,0===o.childNodes.length?\"\":o.childNodes[0].nodeValue),i})),e},e.getTwineStoryStyle=o},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(0);e.formatTwinePassageAsHTML=function(t,e){var n=o.WONDER.template,i=function(t,e,n){var o,a,i=[],r=0;for(;r<t.length;){if(-1===(o=t.indexOf(e,r)))return i;-1===(a=t.indexOf(n,o))&&(a=void 0),i.push(t.substring(o+e.length,a)),r=a+n.length}return i}(e,n.choiceStart,n.choiceEnd)[0];e=e.replace(i,n.choiceText).replace(n.choiceStart,\"\").replace(n.choiceEnd,\"\"),t=(t=t.replace(o.REGEXP.twineLink,(function(t,e){var n=(e=e.trim())[0]==o.WONDER.inlineStart;n&&(e=e.substring(1));var i=n?o.LINK_INLINE_TEMPLATE:o.LINK_TEMPLATE;return function(t,e){return e.replace(o.WONDER.template.choiceId,t.id).replace(o.WONDER.template.choiceText,t.text)}(function(t){var e=t.split(\"|\");e[0]=e[0].trim(),null==e[1]&&(e[1]=e[0]);return new a(e[0],e[1])}(e),i)})).trim()).replace(/(?:\\r\\n|\\r|\\n)/g,\"<br>\");var r=e;return r=r.replace(n.text,t.trim())};var a=function(t,e){this.text=t,this.id=e}},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(8),a=n(24),i=n(5).getTwineStoryStyle();new a.GameView(i);(new o.GameLogic).start()},function(t,e,n){\"use strict\";var o=this&&this.__assign||function(){return(o=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)};Object.defineProperty(e,\"__esModule\",{value:!0});var a=n(3),i=n(10),r=n(0),s=n(11),c=n(12),l=n(13),u=n(14),p=n(1),d=n(5),h=n(15),f=n(18),m=n(21),g=n(22),v=n(23),y=function(){function t(){var t=this;this.isAutoSave=!0,this.isAutoLoad=!0,this.isLoading=!1,this.gameSaveName=\"default\",this.gameConfig=new s.GameConfig,this.history=new l.WonderHistory,this.collections=new f.Collections,this.preprocessor=new g.Preprocessor,this.postMessageApi=new v.PostMessageApi,this.stateRepo=new h.StateRepository(this.postMessageApi),this.audioPlayer=new m.AudioPlayer,this.userScriptApi=new c.UserScriptApi(this.postMessageApi),window.w=this.userScriptApi,window.Wonder=window.w,p.STORE.state=null,p.STORE.user=null,p.STORY_STORE.story=null,a.EventBus.getInstance().sub(\"onPassagePrepared\",(function(e,n){return t.onPassagePrepared(n)})).sub(\"onLinkClick\",(function(e,n){return t.onClick(n)})).sub(\"onBackClick\",(function(e){return t.onBackClick()}))}return t.prototype.start=function(t){var e=this;this.showPreloader().then((function(){return e.startParsing()})).then((function(t){return e.onStoryLoad(t)})).then((function(){return e.preloadUserState()})).then((function(t){return e.onUserStateLoad(t)})).then((function(){return e.preloadGameState()})).then((function(t){return e.onPreloadState(t)})).then((function(){return e.startGame(p.STORY_STORE.story,p.STORE.state,t)}))},t.prototype.showPreloader=function(){var t=this;return new Promise((function(e,n){var o=new i.PreloadPageViewData;t.startPage(o),e()}))},t.prototype.startParsing=function(){return new Promise((function(t,e){t(d.parseTwineData())}))},t.prototype.onStoryLoad=function(t){var e=this;return new Promise((function(n,o){p.STORY_STORE.story=t,p.STORE.user=new u.UserState,p.STORE.state=new u.AppState,e.preprocessor.beforeInitUserScript(),e.collections.beforeInitUserScript(),e.exeScript(p.STORY_STORE.story.script,p.STORE.state.gameVars),e.execUserScriptCommands(),e.collections.onInitUserScript(),n()}))},t.prototype.preloadUserState=function(){var t=this;return new Promise((function(e,n){t.stateRepo.load(\"w-user-data\",(function(t){return e(t)}),(function(t){e(null)}))}))},t.prototype.onUserStateLoad=function(t){return new Promise((function(e,n){null!=t&&(p.STORE.user=t),e()}))},t.prototype.preloadGameState=function(){var t=this;return new Promise((function(e,n){t.stateRepo.load(t.getGameSaveName(),(function(t){return e(t)}),(function(t){e(null)}))}))},t.prototype.onPreloadState=function(t){var e=this;return new Promise((function(n,o){null!=t&&(p.RUNTIME_STORE.hasSave=!0),e.isAutoLoad&&null!=t&&(p.STORE.state=t),n()}))},t.prototype.updateGameState=function(t){null!=t&&(p.STORE.state=o(o({},p.STORE.state),t),this.collections.onStateUpdate())},t.prototype.onGameStateLoad=function(t){this.updateGameState(t),this.startGame(p.STORY_STORE.story,p.STORE.state)},t.prototype.getStartPage=function(t,e){var n=e.history.pages,o=n[n.length-1];return null!=o?o:t.startPassageName},t.prototype.startGame=function(t,e,n){var o=null!=n?n:this.getStartPage(t,e);this.onClick(o)},t.prototype.startPage=function(t){a.EventBus.emit(\"preparePassage\",t)},t.prototype.onPassagePrepared=function(t){this.audioPlayer.musicCheck(t.name),a.EventBus.emit(\"showPassage\",t)},t.prototype.onClick=function(t){var e=Object.assign({},p.STORY_STORE.story.passageHash[t]);this.collections.onPassage(e),this.history.add(t),this.preprocessor.exec(e);var n=this.execPassage(e);this.autoSave(),this.startPage(n)},t.prototype.onBackClick=function(){this.history.pop();var t=this.history.getLast();this.onClick(t)},t.prototype.exeScript=function(t,e){var n=null;try{n=new Function(t).bind(e)()}catch(t){}return n},t.prototype.execPassage=function(t){return this.execScripts(t),this.execUserScriptCommands(),new i.PageViewData(t,p.STORE.state.gameVars,this.gameConfig,this.history.canGoBack(t.name),p.STORE.state.history.pagesHash,p.STORY_STORE.story.passageHash)},t.prototype.execScripts=function(t){var e=this,n=p.STORE.state.gameVars;this.clearRunTimeTextBuffer(),t.content=t.content.replace(r.REGEXP.exeScript,(function(t,o){var a=o.trim(),i=a[0]==r.WONDER.inlineStart;i&&(a=\"return \"+a.substring(1));var s=e.exeScript(a,n),c=e.getRunTimeTextsFromBuffer();return i?s:c}))},t.prototype.getRunTimeTextsFromBuffer=function(){for(var t=p.RUNTIME_STORE.textBuffer,e=\"\";t.length>0;)e+=t.shift();return e},t.prototype.clearRunTimeTextBuffer=function(){p.RUNTIME_STORE.textBuffer=[]},t.prototype.execUserScriptCommands=function(){for(var t=p.RUNTIME_STORE.commands;t.length>0;)this.execSingleUserCommand(t.shift())},t.prototype.execSingleUserCommand=function(t){var e=this;switch(t.name){case\"enableExternalApi\":this.stateRepo.enableExternalApi(t.data);break;case\"saveSlot\":var n=null!=t.data?t.data:\"_default\";this.saveName(n);break;case\"autoSave\":this.isAutoSave=!0===t.data;break;case\"autoLoad\":this.isAutoLoad=!0===t.data;break;case\"save\":if(this.isStatePreload())return;this.saveGameState();break;case\"load\":if(this.isStatePreload())return;this.isLoading=!0,setTimeout((function(){return e.loadGameState()}),0);break;case\"collectionRule\":this.collections.addRule(t.data);break;case\"music\":this.audioPlayer.music(t.data.url,t.data.volume);break;case\"musicFor\":this.audioPlayer.musicFor(t.data.hashName,t.data.url,t.data.volume);break;case\"sound\":this.audioPlayer.sound(t.data.url,t.data.volume);break;case\"musicStop\":this.audioPlayer.stop();break;case\"start\":setTimeout((function(){e.start(t.data.name)}),t.data.delay);break;case\"reset\":p.STORE.state.history.pages.length>1&&this.resetGameState();break;case\"pageAdd\":this.preprocessor.addRule({tag:t.data.tag,text:t.data.text,text2:\"\",position:\"end\"});break;case\"pageBefore\":this.preprocessor.addRule({tag:t.data.tag,text:t.data.text,text2:\"\",position:\"start\"});break;case\"pageWrap\":this.preprocessor.addRule({tag:t.data.tag,text:t.data.text,text2:t.data.text2,position:\"around\"})}},t.prototype.isStatePreload=function(){return null==p.STORE.state||null==p.STORE.state.history||null==p.STORE.state.history.pages||0==p.STORE.state.history.pages.length},t.prototype.saveName=function(t){null!=t&&(this.gameSaveName=t)},t.prototype.saveGameState=function(){this.stateRepo.save(this.getGameSaveName(),p.STORE.state,E,E)},t.prototype.saveUserState=function(){this.stateRepo.save(this.getUserSaveName(),p.STORE.user,E,E)},t.prototype.loadGameState=function(){var t=this;this.isLoading=!0,this.stateRepo.load(this.getGameSaveName(),(function(e){t.isLoading=!1,t.onGameStateLoad(e)}),(function(e){t.isLoading=!1}))},t.prototype.getGameSaveName=function(){return\"w-game-\"+this.gameSaveName},t.prototype.getUserSaveName=function(){return\"w-user-data\"},t.prototype.autoSave=function(){this.isAutoSave&&(this.isLoading||(this.saveGameState(),this.saveUserState()))},t.prototype.resetGameState=function(){var t=this.history.getLast();this.start(t)},t}();function E(t){}e.GameLogic=y},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=requestAnimationFrame?function(t){return requestAnimationFrame(t)}:function(t){return setTimeout(t,0)};e.Task={order:o}},function(t,e,n){\"use strict\";var o,a=this&&this.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,\"__esModule\",{value:!0});var i=n(0),r=function(t,e,n,o,a,i){this.passage=t,this.gameVars=e,this.config=n,this.canGoBack=o,this.visitedPagesMap=a,this.pagesMap=i};e.PageViewData=r;var s={pid:i.WONDER.preloadId,position:\"\",name:\"preload\",tags:\"\",size:\"\",content:i.PRELOAD_PAGE_TEMPLATE},c=function(t){function e(){return t.call(this,s,{},{uiParams:[]},!1,{},{})||this}return a(e,t),e}(r);e.PreloadPageViewData=c},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=function(){};e.GameState=o;var a=function(){this.uiParams=[]};e.GameConfig=a;var i=function(t,e){this.name=t,this.label=e};e.VisibleParameter=i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(1),a=function(){function t(t){this.autoload=this.autoLoad,this.autosave=this.autoSave,this.postMessageApi=t}return t.prototype.styleUrl=function(t){var e=document.createElement(\"link\");e.setAttribute(\"rel\",\"stylesheet\"),e.setAttribute(\"href\",t),document.head.appendChild(e)},t.prototype.jsUrl=function(t,e){var n=document.createElement(\"script\");n.type=\"text/javascript\",e&&(n.onload=function(){e()}),n.src=t,document.head.appendChild(n)},t.prototype.collect=function(t){o.RUNTIME_STORE.commands.push({name:\"collectionRule\",data:t})},t.prototype.music=function(t,e){void 0===e&&(e=1),o.RUNTIME_STORE.commands.push({name:\"music\",data:{url:t,volume:e}})},t.prototype.musicFor=function(t,e,n){void 0===n&&(n=1),o.RUNTIME_STORE.commands.push({name:\"musicFor\",data:{url:e,volume:n,hashName:t}})},t.prototype.sound=function(t,e){void 0===e&&(e=1),o.RUNTIME_STORE.commands.push({name:\"sound\",data:{url:t,volume:e}})},t.prototype.musicStop=function(){o.RUNTIME_STORE.commands.push({name:\"musicStop\",data:null})},t.prototype.parentApi=function(){return this.postMessageApi},t.prototype.disableLocalSave=function(t){void 0===t&&(t=!0),o.RUNTIME_STORE.commands.push({name:\"enableExternalApi\",data:!0})},t.prototype.enableExternalApi=function(t){void 0===t&&(t=!0),o.RUNTIME_STORE.commands.push({name:\"enableExternalApi\",data:!0})},t.prototype.hasSave=function(){return o.RUNTIME_STORE.hasSave},t.prototype.autoLoad=function(t){void 0===t&&(t=!0),o.RUNTIME_STORE.commands.push({name:\"autoLoad\",data:t})},t.prototype.autoSave=function(t){void 0===t&&(t=!0),o.RUNTIME_STORE.commands.push({name:\"autoSave\",data:t})},t.prototype.saveSlot=function(t){o.RUNTIME_STORE.commands.push({name:\"saveSlot\",data:t})},t.prototype.save=function(t){null!=t&&this.saveSlot(t),o.RUNTIME_STORE.commands.push({name:\"save\",data:t})},t.prototype.load=function(t){null!=t&&this.saveSlot(t),o.RUNTIME_STORE.commands.push({name:\"load\",data:t})},t.prototype.start=function(t,e){void 0===t&&(t=0),void 0===e&&(e=null),o.RUNTIME_STORE.commands.push({name:\"start\",data:{delay:t,name:e}})},t.prototype.reset=function(){o.RUNTIME_STORE.commands.push({name:\"reset\",data:{}})},t.prototype.showText=function(t){o.RUNTIME_STORE.textBuffer.push(t)},t.prototype.pageAdd=function(t,e){o.RUNTIME_STORE.commands.push({name:\"pageAdd\",data:{tag:t,text:e}})},t.prototype.pageBefore=function(t,e){o.RUNTIME_STORE.commands.push({name:\"pageBefore\",data:{tag:t,text:e}})},t.prototype.pageWrap=function(t,e,n){o.RUNTIME_STORE.commands.push({name:\"pageWrap\",data:{tag:t,text:e,text2:n}})},t}();e.UserScriptApi=a},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(1),a=function(){function t(){}return t.prototype.getState=function(){return o.STORE.state.history},t.prototype.add=function(t){null!=t&&this.getLast()!=t&&(this.getState().pages.push(t),this.getState().pagesHash[t]=!0)},t.prototype.isVisited=function(t){return 1==this.getState().pagesHash[t]},t.prototype.pop=function(){return this.getState().pages.pop()},t.prototype.canGoBack=function(t){var e=this.getState().pages;if(!(e.length>0))return!1;var n=1==e.length,o=e[0]&&e[0]==t;return!(n&&o)},t.prototype.getLast=function(){var t=this.getState().pages;return t[t.length-1]},t}();e.WonderHistory=a},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=function(){this.gameVars={},this.history={pagesHash:{},pages:[]}};e.AppState=o;var a=function(){this.collectionMap={}};e.UserState=a},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(16),a=n(17),i=function(){function t(t){this.loadTimes={},this.saveTimes={},this.operationDelta=150,this.localRepo=new o.LocalRepository,this.postMessageRepo=new a.PostMessageRepository(t),this.repo=this.localRepo}return t.prototype.enableExternalApi=function(t){this.repo=t?this.postMessageRepo:this.localRepo},t.prototype.load=function(t,e,n){var o=Date.now();o-(this.loadTimes[t]||0)<this.operationDelta||(this.loadTimes[t]=o,this.repo.load(t,e,n))},t.prototype.save=function(t,e,n,o){var a=Date.now();a-(this.saveTimes[t]||0)<this.operationDelta||(this.saveTimes[t]=a,this.repo.save(t,e,n,o))},t}();e.StateRepository=i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=function(){function t(){}return t.prototype.save=function(t,e,n,o){try{var a=JSON.stringify(e);localStorage.setItem(t,a),n(\"success\")}catch(e){o(\"localRepository saveError for key [\"+t+\"] :: \"+e)}},t.prototype.load=function(t,e,n){try{var o=localStorage.getItem(t);e(JSON.parse(o))}catch(e){n(\"localRepository loadError for key [\"+t+\"] :: \"+e)}},t}();e.LocalRepository=o},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=function(){function t(t){this.postMessageApi=t,this.callbacks={},this.setHandlers()}return t.prototype.save=function(t,e,n,o){try{var a=JSON.stringify(e);this.callbacks.save=n,this.callbacks.saveError=o,this.postMessageApi.send(\"save\",{saveName:t,data:a})}catch(e){o(\"postMessageRepository save Error for slotName [\"+t+\" :: \"+e)}},t.prototype.load=function(t,e,n){this.callbacks.load=e,this.callbacks.loadError=n,this.postMessageApi.send(\"load\",{saveName:t})},t.prototype.setHandlers=function(){var t=this;this.setMessageHandler(\"save\"),this.setMessageHandler(\"saveError\"),this.setMessageHandler(\"loadError\"),this.postMessageApi.on(\"load\",(function(e){return t.onLoad(e)}))},t.prototype.setMessageHandler=function(t){var e=this;this.postMessageApi.on(t,(function(n){var o=n.saveName+\" \"+n.data;e.callbacks[t](\"PostMessages.\"+t+\" :: \"+o)}))},t.prototype.onLoad=function(t){var e=t.saveName,n=t.data;try{var o=this.callbacks.load,a=this.callbacks.loadError;if(null==n)a(\"PostMessages.loadError :: null save for \"+e);else o(JSON.parse(n))}catch(t){(a=this.callbacks.loadError)(\"PostMessages.loadError :: \"+t+\"  for \"+e)}},t}();e.PostMessageRepository=o},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(19),a=n(1),i=function(){function t(){this.collectionsView=new o.CollectionsView}return t.prototype.getCollectionMap=function(){return a.STORE.user.collectionMap},t.prototype.getCollection=function(t){return a.STORE.user.collectionMap[t]},t.prototype.beforeInitUserScript=function(){this.rulesMap={}},t.prototype.onInitUserScript=function(){var t=this;this.initCollections(),setTimeout((function(){t.collectionsView.createButtons(t.getCollectionMap())}),500)},t.prototype.onStateUpdate=function(){this.collectionsView.updateButtons(this.getCollectionMap())},t.prototype.addRule=function(t){var e=this;t.tags.forEach((function(n){null==e.rulesMap[n]&&(e.rulesMap[n]=[]),e.rulesMap[n].push(t)})),this.addCollection(t)},t.prototype.onPassage=function(t){var e=this;this.getTags(t).forEach((function(n){return e.collectTag(n,t)})),this.onStateUpdate()},t.prototype.collectTag=function(t,e){var n=this,o=this.rulesMap[t];null==o||o.length<1||o.forEach((function(t){return n.collectByRule(t,e)}))},t.prototype.collectByRule=function(t,e){var n=this.getCollectionMap()[t.collection];n.collected.indexOf(e.name)<0&&(n.collected.push(e.name),this.onPassageCollected(e,n))},t.prototype.onPassageCollected=function(t,e){this.collectionsView.updateButton(e)},t.prototype.addCollection=function(t){null==this.getCollection(t.collection)&&(this.getCollectionMap()[t.collection]={name:t.collection,title:t.title,collected:[],maxAmount:0})},t.prototype.initCollections=function(){var t=this,e=a.STORY_STORE.story;Object.keys(this.getCollectionMap()).forEach((function(e){t.getCollection(e).maxAmount=0})),e.passages.forEach((function(e){t.getTags(e).forEach((function(e){var n=t.rulesMap[e];null!=n&&n.forEach((function(e){var n=t.getCollection(e.collection);null!=n&&n.maxAmount++}))}))}))},t.prototype.getTags=function(t){return t.tags.split(\" \")},t}();e.Collections=i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(20),a=n(2),i=function(){function t(){var t=this;this.isViewCreated=!1,this.viewMap={},this.buttonWrapper=document.createElement(\"div\"),this.buttonWrapper.id=\"c-wrapper\",this.buttonWrapper.addEventListener(\"mouseup\",(function(e){return t.findButton(e)})),this.shadow=document.createElement(\"div\"),this.shadow.id=\"c-shadow\",this.shadow.style.display=\"none\",this.shadow.style.position=\"absolute\",this.shadow.style.width=\"100%\",this.shadow.style.height=\"100%\",this.shadow.style.background=\"#000\",this.shadow.style.opacity=\"0.3\",this.shadow.addEventListener(\"mouseup\",(function(e){return t.closeAll()})),document.body.appendChild(this.shadow)}return t.prototype.createButtons=function(t){var e=this;this.buttonWrapper.innerHTML=\"\",Object.keys(t).forEach((function(n){var a=t[n],i=new o.SingleCollectionView;e.viewMap[n]=i,i.update(a),i.onCollectionShow((function(t){return e.onCollectionShow(t)})),i.attach(e.buttonWrapper)})),this.isViewCreated=!0,document.body.appendChild(this.buttonWrapper)},t.prototype.updateButtons=function(t){var e=this;Object.keys(t).forEach((function(n){var o=t[n];e.updateButton(o)}))},t.prototype.updateButton=function(t){if(this.isViewCreated){var e=this.viewMap[t.name];null!=e&&e.update(t)}},t.prototype.onCollectionShow=function(t){var e=this;Object.keys(this.viewMap).forEach((function(n){t!=n&&e.viewMap[n].closeCollection()}))},t.prototype.findButton=function(t){var e=this,n=a.DomUtils.closest(t.target,\".c-button\");if(n){var o=n.dataset.collection;Object.keys(this.viewMap).forEach((function(t){var n=e.viewMap[t];null!=n&&(t==o?(e.shadow.style.display=\"block\",n.showCollection()):n.closeCollection())}))}},t.prototype.closeAll=function(){var t=this;Object.keys(this.viewMap).forEach((function(e){t.viewMap[e].closeCollection()})),this.shadow.style.display=\"none\"},t}();e.CollectionsView=i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(1),a=n(6),i=n(0),r=n(2),s=function(){function t(t,e,n){void 0===t&&(t=\"c-button\"),void 0===e&&(e=\"c-list\"),void 0===n&&(n=\"c-page\"),this.buttonClass=t,this.listClass=e,this.pageClass=n,this.buttonEl=this.createButton(t),this.listEl=this.createList(e),this.pageEl=this.createPage(n)}return t.prototype.attach=function(t){t=t||document.body,document.body.appendChild(this.listEl),document.body.appendChild(this.pageEl),t.appendChild(this.buttonEl)},t.prototype.update=function(t){this.updateButton(t),this.updateListTitle(t),this.updateList(t)},t.prototype.onCollectionShow=function(t){this.onButtonClickCallback=t},t.prototype.createButton=function(t){var e=this.createDiv(t);return this.buttonTitleEl=this.createDiv(\"c-bt-title\"),this.buttonContentEl=this.createDiv(\"c-bt-content\"),e.appendChild(this.buttonTitleEl),e.appendChild(this.buttonContentEl),e},t.prototype.createList=function(t){var e=this,n=this.createDiv(t);return n.addEventListener(\"click\",(function(t){return e.findItem(t)})),this.listTitleEl=this.createDiv(\"c-list-title\"),this.listContentEl=this.createDiv(\"c-list-content\"),n.appendChild(this.listTitleEl),n.appendChild(this.listContentEl),n},t.prototype.createPage=function(t){var e=this,n=this.createDiv(t);return n.addEventListener(\"mouseup\",(function(){return e.closePage()})),n},t.prototype.updateButton=function(t){var e=this.buttonEl,n=this.buttonTitleEl,o=this.buttonContentEl;this.collectionName=t.name;var a=t.collected.length,i=t.maxAmount,r=t.title;e.dataset.collection=this.collectionName,n.innerHTML=\"\"+r,o.innerHTML=a+\"/\"+i;var s=a==i?\"c-button-completed\":\"\";e.className=\"c-button \"+this.collectionName+\" \"+s},t.prototype.updateListTitle=function(t){this.listTitleEl.innerHTML=t.title},t.prototype.updateList=function(t){var e=this,n=this.listEl,a=this.listContentEl;a.innerHTML=\"\";var i=o.STORY_STORE.story.passageHash,r=\"\";t.collected.forEach((function(t){var n=i[t],o=e.getPageTitle(n.content),a=e.getItemTemplate(o,t);r+=a})),a.innerHTML=r,n.className=\"c-list \"+this.collectionName},t.prototype.updatePage=function(t){var e=this.pageEl;e.innerHTML=\"\";var n=t.content.replace(i.REGEXP.exeScript,\"\"),o=i.PASSAGE_TEMPLATE,r=a.formatTwinePassageAsHTML(n,o);e.innerHTML=r},t.prototype.showCollection=function(){this.listEl.classList.add(\"c-list-show\"),this.onCollectionShow&&this.onButtonClickCallback(this.collectionName)},t.prototype.closeCollection=function(){this.listEl.classList.remove(\"c-list-show\"),this.closePage()},t.prototype.findItem=function(t){var e=r.DomUtils.closest(t.target,\".c-item\");e&&this.onItemClick(e.dataset.name)},t.prototype.onItemClick=function(t){var e=o.STORY_STORE.story.passageHash[t];null!=e&&(this.updatePage(e),this.showPage())},t.prototype.getPageTitle=function(t){var e=function(t,e,n,o){void 0===o&&(o=!1);var a=t.indexOf(e);if(a<0)return\"\";var i=t.indexOf(n,a),r=o?0:e.length,s=o?n.length:0;return t.substring(a+r,i+s)}(t,\"<h1>\",\"</h1>\");return null!=e&&0!=e.length||(e=function(t){var e=t.indexOf(\"\\n\");if(-1===e)return t;return t.substr(0,e)}(t)),e},t.prototype.showPage=function(){this.pageEl.classList.add(\"c-page-show\")},t.prototype.closePage=function(){this.pageEl.classList.remove(\"c-page-show\")},t.prototype.createDiv=function(t){var e=document.createElement(\"div\");return e.className=t,e},t.prototype.getItemTemplate=function(t,e){return'<div class=c-item data-name=\"'+e+'\">'+t+\"</div>\"},t}();e.SingleCollectionView=s},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=function(){function t(){this.musicHash={},this.audioElement=new Audio}return t.prototype.music=function(t,e){this.audioElement.loop=!0,this.play(t,e)},t.prototype.sound=function(t,e){this.audioElement.loop=!1,this.play(t,e)},t.prototype.musicFor=function(t,e,n){this.musicHash[t]={url:e,volume:n}},t.prototype.musicCheck=function(t){var e=this.musicHash[t];null!=e&&this.music(e.url,e.volume)},t.prototype.play=function(t,e){var n=t.trim();this.lastUrl=n,this.audioElement.src=this.lastUrl,this.audioElement.volume=e,(this.audioElement.paused||n!=this.lastUrl)&&this.audioElement.play().then((function(t){}))},t.prototype.stop=function(){this.audioElement.pause()},t}();e.AudioPlayer=o},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=function(){function t(){}return t.prototype.beforeInitUserScript=function(){this.rulesMap={}},t.prototype.addRule=function(t){this.getRules(t.tag).push(t)},t.prototype.exec=function(t){var e=this;this.getTags(t).forEach((function(n){e.getRules(n).forEach((function(n){return e.useRule(t,n)}))}))},t.prototype.initTag=function(t){null==this.rulesMap[t]&&(this.rulesMap[t]=[])},t.prototype.getRules=function(t){return this.initTag(t),this.rulesMap[t]},t.prototype.getTags=function(t){return t.tags.split(\" \")},t.prototype.useRule=function(t,e){var n=null!=e.text2?e.text2:\"\";switch(e.position){case\"start\":t.content=e.text+t.content;break;case\"end\":t.content=t.content+e.text;break;case\"around\":t.content=e.text+t.content+n}},t}();e.Preprocessor=o},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=function(){function t(t,e){var n=this;void 0===t&&(t=null),void 0===e&&(e=\"*\"),this.listenerMap={},this.parent=t,null==this.parent&&(this.parent=window.parent),this.targetOrigin=e,window.addEventListener(\"message\",(function(t){return n.onMessage(t)}))}return t.prototype.send=function(t,e){var n={name:t,data:e};this.parent&&this.parent.postMessage(n,this.targetOrigin)},t.prototype.on=function(t,e){null==this.listenerMap[t]&&(this.listenerMap[t]=[]),this.listenerMap[t].push(e)},t.prototype.onMessage=function(t){var e=t.data;if(null!=e.name){var n=this.listenerMap[e.name];n&&n.forEach((function(t){return t(e.data)}))}},t}();e.PostMessageApi=o},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(3),a=n(0),i=n(25),r=n(2),s=function(){function t(t){var e=this;this.injectStyle(a.DEFAULT_STYLE),this.injectStyle(t),this.el=document.createElement(\"div\"),this.el.id=a.WONDER.contentId,document.body.appendChild(this.el),this.el.addEventListener(\"click\",this),this.pageView=new i.WonderPageView(this.el),o.EventBus.getInstance().sub(\"onStoryLoaded\",(function(t,n){return e.onStoryLoad(n)})).sub(\"preparePassage\",(function(t,n){return e.preparePassage(n)})).sub(\"showPassage\",(function(t,n){return e.showPassage(n)}))}return t.prototype.injectStyle=function(t){if(0!=t.length){var e=document.createElement(\"style\");e.innerHTML=t,document.getElementsByTagName(\"head\")[0].appendChild(e)}},t.prototype.handleEvent=function(t){this.checkLinkClick(t)||this.checkBackClick(t)},t.prototype.checkClick=function(t,e,n){var o=r.DomUtils.closest(t.target,e);return o&&n(o,t),null!=o},t.prototype.checkLinkClick=function(t){return this.checkClick(t,\".\"+a.WONDER.linkClass,(function(t,e){var n=t.dataset.id;o.EventBus.emit(\"onLinkClick\",n)}))},t.prototype.checkBackClick=function(t){return this.checkClick(t,\".\"+a.WONDER.backClass,(function(t,e){o.EventBus.emit(\"onBackClick\",null)}))},t.prototype.onStoryLoad=function(t){},t.prototype.preparePassage=function(t){var e=t.passage,n=this.pageView.addNextPage(e);this.setBody(e),this.markVisitedLinks(n,t.visitedPagesMap,t.pagesMap),this.showBackLink(n,t.canGoBack,e),this.injectParams(n,t.config.uiParams,t.gameVars),o.EventBus.emit(\"onPassagePrepared\",e)},t.prototype.setBody=function(t){document.body.id=t.name,document.body.className=t.tags},t.prototype.showPassage=function(t){this.pageView.showNextPage()},t.prototype.injectParams=function(t,e,n){e.forEach((function(e){var o=e.name,a=n[e.name],i=t.querySelector(e.name);i&&(i.innerHTML=o+\":\"+a)}))},t.prototype.markVisitedLinks=function(t,e,n){for(var o,i,r=t.querySelectorAll(\".\"+a.WONDER.linkClass),s=0;s<r.length;s++){e[i=(o=r[s]).dataset.id]&&o.classList.add(a.WONDER.visitedClass);var c=n[i];c&&c.tags&&(o.className=o.className+\" \"+c.tags)}},t.prototype.showBackLink=function(t,e,n){var o=t.querySelector(\".\"+a.WONDER.backClass);null!=o&&(e?o.classList.remove(a.WONDER.invisibleClass):o.classList.add(a.WONDER.invisibleClass))},t}();e.GameView=s},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(26),a=n(3),i=n(29),r=n(0),s=n(6),c=function(){function t(t){var e=this;this.parent=t,this.pageView=new o.PagePairView,this.pageBuilder=new i.ViewBuilder(r.PAGE_TEMPLATE),this.contentBuilder=new i.ViewBuilder(r.PASSAGE_TEMPLATE),this.contentBuilder.setContentFormatter(s.formatTwinePassageAsHTML),a.EventBus.getInstance().sub(\"onPageFormatLoaded\",(function(t,n){return e.pageBuilder.setTemplate(n)})).sub(\"onPassageFormatLoaded\",(function(t,n){return e.contentBuilder.setTemplate(n)}))}return t.prototype.addNextPage=function(t){var e=this.buildPageView(t);return this.pageView.addPage(e),e},t.prototype.showNextPage=function(){this.pageView.next()},t.prototype.buildPageView=function(t){var e=t.content,n=this.contentBuilder.build(e),o=this.pageBuilder.build();return o.classList.add(r.COMMON_CSS.displayNone),o.appendChild(n),this.parent.appendChild(o),o},t}();e.WonderPageView=c},function(t,e,n){\"use strict\";var o,a=this&&this.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,\"__esModule\",{value:!0});var i=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.limit=2,e}return a(e,t),e.prototype.addPage=function(e){t.prototype.addPage.call(this,e),this.pages.length>this.limit&&(this.currentPage--,this.dropPage(0))},e}(n(27).PageView);e.PagePairView=i},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(28),a=n(4),i=n(2),r=function(){function t(){this.pages=[],this.currentPage=-1,this.animator=new o.PageAnimator}return t.prototype.setAnimator=function(t){this.animator=t},t.prototype.addPage=function(t){this.pages.push(t)},t.prototype.next=function(){var t=this.getCurrent();this.currentPage++,this.setCurrent(this.currentPage);var e=this.getCurrent();this.switch(t,e)},t.prototype.previous=function(){var t=this.getCurrent();this.currentPage--,this.setCurrent(this.currentPage);var e=this.getCurrent();this.switch(t,e)},t.prototype.switch=function(t,e){t&&this.animator.hide(t),this.animator.show(e)},t.prototype.getCurrent=function(){return this.pages[this.currentPage]},t.prototype.setCurrent=function(t){if(0==this.pages.length)throw\"setCurrent error - void pages\";var e=this.pages.length-1;t>e?t=0:t<0&&(t=e),this.currentPage=t},t.prototype.dropPage=function(t){var e=a.ArrayUtils.remove(this.pages,t);null!=e&&i.DomUtils.remove(e)},t}();e.PageView=r},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(0),a=function(){function t(){}return t.prototype.show=function(t,e){void 0===e&&(e=0),t.classList.remove(o.COMMON_CSS.displayNone)},t.prototype.hide=function(t,e){void 0===e&&(e=0),t.classList.add(o.COMMON_CSS.displayNone)},t}();e.PageAnimator=a},function(t,e,n){\"use strict\";Object.defineProperty(e,\"__esModule\",{value:!0});var o=n(2),a=function(){function t(t){this.template=t,this.contentFormatter=function(t,e){return e}}return t.prototype.setTemplate=function(t){this.template=t},t.prototype.setContentFormatter=function(t){this.contentFormatter=t},t.prototype.build=function(t){void 0===t&&(t=\"\");var e=this.contentFormatter(t,this.template);return o.DomUtils.elementFromTemplate(e)},t}();e.ViewBuilder=a}]);"+ '</script>' +
    '        </body>\n' +
    '    </html>';


window.storyFormat({
    name: 'twine-wonder',
    version: '0.6.19',
    author: 'Kvisaz [Sergey Tokarev]',
    description: 'Twine Wonder Format',
    proofing: false,
    url: 'https://github.com/Kvisaz/twine-wonder',
    image: 'icon.svg',
    source: SOURCE,
});
